<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>using llvm – EECE7398 Fall 2024</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../lectures/mem_consistancy.html" rel="next">
<link href="../lectures/junk.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


<meta property="og:title" content="using llvm – EECE7398 Fall 2024">
<meta property="og:description" content="Homepage EECS7398 - Special Topic: Compilers, Fall 2024.">
<meta property="og:site_name" content="EECE7398 Fall 2024">
</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    <div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="revealjs_llvm.qmd.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../weekly.html">EECS 7398</a></li><li class="breadcrumb-item"><a href="../lectures/010_compiler_overview.html">Lectures</a></li><li class="breadcrumb-item"><a href="../lectures/llvm.html">using llvm</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">using llvm</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="using-llvm" class="level1">
<h1>Using LLVM</h1>
<p>handy links</p>
<p><a href="https://llvm.org/docs/ProgrammersManual.html">llvm programmers guide</a></p>
<p><a href="https://www.cs.cornell.edu/~asampson/blog/llvm.html">Adrians tutorial</a></p>
<p><a href="https://github.com/sampsyo/llvm-pass-skeleton">skeleton code</a></p>
<p><a href="https://llvm.org/docs/LangRef.html">llvm doc</a></p>
<p>google, github pilot and chatgpt are very useful.</p>
<section id="install-clang-and-friends" class="level2">
<h2 class="anchored" data-anchor-id="install-clang-and-friends">install clang and friends</h2>
<p>as a first step I’m going to show how to install clang and cmake</p>
<pre><code>sudo apt install clang cmake </code></pre>
</section>
</section>
<section id="lets-take-a-look-at-llvm-ir" class="level1">
<h1>lets take a look at llvm ir</h1>
<pre><code>// temp.c
int main(int argc, char** argv){
       return argc;}</code></pre>
<p>dump the ir</p>
<ol type="1">
<li>-emit-llvm print the ir</li>
<li>-S print as text not as binary</li>
<li>0 - output to stdout</li>
</ol>
<p>clang -emit-llvm -S -o - temp.c</p>
<section id="llvm-ir" class="level2">
<h2 class="anchored" data-anchor-id="llvm-ir">llvm ir</h2>
<pre><code>clang -emit-llvm -S -o - temp.c

; ModuleID = 'temp.c'
source_filename = "temp.c"
target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-pc-linux-gnu"

; Function Attrs: noinline nounwind optnone uwtable
define dso_local i32 @main(i32 noundef %0, i8** noundef %1) #0 {
  %3 = alloca i32, align 4
  %4 = alloca i32, align 4
  %5 = alloca i8**, align 8
  store i32 0, i32* %3, align 4
  store i32 %0, i32* %4, align 4
  store i8** %1, i8*** %5, align 8
  %6 = load i32, i32* %4, align 4
  ret i32 %6
}</code></pre>
<p>compared to bril</p>
<p>more complex types, variables are %n, assumes a stack, must be in ssa</p>
</section>
<section id="using-copilet" class="level2">
<h2 class="anchored" data-anchor-id="using-copilet">using copilet</h2>
<p>what does the llvm alloca do</p>
<p>In LLVM, the alloca instruction is used to allocate memory on the stack. It stands for “allocate” and is similar to the alloca function in C. The memory allocated by alloca is automatically freed when the function returns, making it suitable for allocating temporary storage within a function.</p>
<pre><code>Explanation of alloca Instruction
Syntax: alloca &lt;type&gt;, &lt;num_elements&gt;, &lt;alignment&gt;
&lt;type&gt;: The type of the elements to be allocated.
&lt;num_elements&gt;: The number of elements to allocate (optional, defaults to 1).
&lt;alignment&gt;: The alignment of the allocated memory (optional).
Example from the Provided Code
Explanation:
%3 = alloca i32, align 4:

Allocates memory for a single i32 (32-bit integer) on the stack.
The allocated memory is aligned to a 4-byte boundary.
The result is a pointer to the allocated memory, stored in the variable %3.
%4 = alloca i32, align 4:

Similar to the first instruction, this allocates memory for another i32 on the stack with 4-byte alignment.
The result is stored in the variable %4.
%5 = alloca i8**, align 8:

Allocates memory for a single i8** (pointer to a pointer to an 8-bit integer) on the stack.
The allocated memory is aligned to an 8-byte boundary.
The result is stored in the variable %5.
Usage:
Temporary Storage: alloca is typically used for temporary storage within a function, such as local variables.
Automatic Deallocation: The memory allocated by alloca is automatically deallocated when the function returns, so there is no need to manually free it.
Example in Context:
In the provided LLVM IR code, the alloca instructions are used to allocate space for local variables %3, %4, and %5 on the stack. These variables are then used to store values and perform operations within the main function.

In this function:

%3 is allocated for an i32 and initialized to 0.
%4 is allocated for an i32 and initialized with the value of the first argument %0.
%5 is allocated for an i8** and initialized with the value of the second argument %1.
The value stored in %4 is loaded into %6 and returned.
This demonstrates how alloca is used to manage local variables within an LLVM function.</code></pre>
</section>
<section id="llvm-classes" class="level2">
<h2 class="anchored" data-anchor-id="llvm-classes">llvm classes</h2>
<p>what is llvm value</p>
<pre><code>In LLVM, a Value is a fundamental class that represents a typed constant or variable. It is the base class for all values computed by a program that may be used as operands to other values. This includes constants, instructions, function arguments, and more.

Key Points about llvm::Value:
Base Class: llvm::Value is the base class for many other classes in LLVM, such as llvm::Instruction, llvm::Constant, llvm::Argument, and llvm::GlobalVariable.
Typed: Every Value has a type, represented by the llvm::Type class. This type information is crucial for type checking and code generation.
Use-Def Chain: Value objects maintain a list of uses, which are the places where the value is used. This is part of the use-def (use-definition) chain, which is important for optimizations and transformations.

Common Subclasses of llvm::Value:
llvm::Instruction: Represents an individual instruction in the LLVM IR.
llvm::Constant: Represents a constant value, such as an integer or floating-point constant.
llvm::Argument: Represents an argument to a function.
llvm::GlobalVariable: Represents a global variable.</code></pre>
</section>
<section id="llvm-classes-llvm-is-c-but-does-not-use-standard-library" class="level2">
<h2 class="anchored" data-anchor-id="llvm-classes-llvm-is-c-but-does-not-use-standard-library">llvm classes (llvm is c++ but does not use standard library)</h2>
<ol type="1">
<li>llvm does not use char* or std::string, it has something else called a StringRef.</li>
<li>there is no std::cout or std::cerr there are outs(), errs()</li>
<li>lot of built in data structures</li>
<li>complex class hierarchy</li>
</ol>
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>flowchart TD;</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>Value --&gt; Argument ;</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>Value --&gt; other["..."];</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>Value --&gt; User;</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>User --&gt; Constant</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>User--&gt; Operator</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>User--&gt; Instruction</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>Constant --&gt; ConstantExpr</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>Constant--&gt; ConstantData</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>Operator--&gt; ConcreteOperator</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>Instruction--&gt; UnaryInst</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>ConstantData --&gt; ConstantInt</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>ConstantData --&gt; UndefValue</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>Instruction --&gt; BinaryOperator</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>Instruction--&gt; CallBase</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%

flowchart TD;
Value --&gt; Argument ;
Value --&gt; other["..."];
Value --&gt; User;
User --&gt; Constant
User--&gt; Operator
User--&gt; Instruction
Constant --&gt; ConstantExpr
Constant--&gt; ConstantData
Operator--&gt; ConcreteOperator
Instruction--&gt; UnaryInst
ConstantData --&gt; ConstantInt
ConstantData --&gt; UndefValue
Instruction --&gt; BinaryOperator
Instruction--&gt; CallBase
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>Instructions are a kind of Value, since everything is in SSA form, so in memory operands are pointers to instructions</p>
</section>
<section id="plugins" class="level2">
<h2 class="anchored" data-anchor-id="plugins">plugins</h2>
<p>An LLVM plugin is a shared library that can add additional functionality to the LLVM infrastructure. Plugins can be used to add new passes, analyses, targets, and more.</p>
<p>Plugins are dynamically loaded into LLVM. Once loaded, a plugin can register new command-line options, passes, etc., that are then available for use in that invocation of the tool.</p>
<p>The advantage for us is that using a plugin means you do not have to ever build llvm from source.</p>
<p>There is a cs6120 package that makes setting up the build process for plugins simpler</p>
<p><a href="https://github.com/sampsyo/llvm-pass-skeleton">pass starter</a></p>
<p>This has branches</p>
<p>master - prints names of functions</p>
<p>containers - prints everything</p>
<p>mutate - changes the code</p>
<p>rtlib - easier way to insert code with needing irbuilder</p>
</section>
<section id="using-llvm-branches" class="level2">
<h2 class="anchored" data-anchor-id="using-llvm-branches">using llvm branches</h2>
<p>To clone a specific branch from a GitHub repository, you can use the git clone command with the -b option followed by the branch name and the repository URL. Here is the syntax:</p>
<p>git clone -b <branch-name> <repository-url> <target-directory></target-directory></repository-url></branch-name></p>
<p>to switch branches</p>
<p>git fetch –all</p>
<p>git checkout <branch-name></branch-name></p>
</section>
<section id="using-the-master-branch" class="level2">
<h2 class="anchored" data-anchor-id="using-the-master-branch">using the master branch</h2>
<p>git clone https://github.com/sampsyo/llvm-pass-skeleton</p>
<p>ls gives</p>
<p>CMakeLists.txt LICENSE README.md skeleton</p>
<p>ls skeleton CMakeLists.txt Skeleton.cpp</p>
</section>
<section id="skeleton.cpp" class="level2">
<h2 class="anchored" data-anchor-id="skeleton.cpp">Skeleton.cpp</h2>
<pre><code>#include "llvm/Pass.h"
#include "llvm/Passes/PassBuilder.h"
#include "llvm/Passes/PassPlugin.h"
#include "llvm/Support/raw_ostream.h"

using namespace llvm;

namespace {

struct SkeletonPass : public PassInfoMixin&lt;SkeletonPass&gt; {
    PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;AM) {
        for (auto &amp;F : M) {
            errs() &lt;&lt; "I saw a function called " &lt;&lt; F.getName() &lt;&lt; "!\n";
        }
        return PreservedAnalyses::all();
    };
};

}

extern "C" LLVM_ATTRIBUTE_WEAK ::llvm::PassPluginLibraryInfo
llvmGetPassPluginInfo() {
    return {
        .APIVersion = LLVM_PLUGIN_API_VERSION,
        .PluginName = "Skeleton pass",
        .PluginVersion = "v0.1",
        .RegisterPassBuilderCallbacks = [](PassBuilder &amp;PB) {
            PB.registerPipelineStartEPCallback(
                [](ModulePassManager &amp;MPM, OptimizationLevel Level) {
                    MPM.addPass(SkeletonPass());
                });
        }
    };
}</code></pre>
</section>
<section id="how-to-build-this" class="level2">
<h2 class="anchored" data-anchor-id="how-to-build-this">how to build this</h2>
<pre><code>~/llvm/llvm-pass-skeleton$ mkdir build
cd build 
 cmake ..
</code></pre>
<p>– Registering SkeletonPass as a pass plugin (static build: OFF) – Configuring done – Generating done – Build files have been written to: /home/norm/llvm/llvm-pass-skeleton/build</p>
<pre><code>
This generates build/skeleton/SkeletonPass.so

to run this 

clang -fpass-plugin=llvm-pass-skeleton/build/skeleton/SkeletonPass.so a.cpp

creates a.out and prints out info from the pass


to make this easier to use you might create a bash script or a makefile 

## look at the post on containers 

## getting more info 

Some helpfull llvm operations
</code></pre>
<p>errs() &lt;&lt; “function Body:”; errs() &lt;&lt; F &lt;&lt; ‘“;’</p>
<pre><code>
output</code></pre>
<p>I saw a function called main! function Body: ; Function Attrs: noinline nounwind optnone uwtable define dso_local i32 <span class="citation" data-cites="main">@main</span>(i32 noundef %0, i8** noundef %1) #0 { %3 = alloca i32, align 4 %4 = alloca i32, align 4 %5 = alloca i8<strong>, align 8 store i32 0, i32* %3, align 4 store i32 %0, i32* %4, align 4 store i8</strong> %1, i8*** %5, align 8 %6 = load i32, i32* %4, align 4 ret i32 %6 }</p>
<pre><code>
## entering containers </code></pre>
<p>PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;AM) { for (auto &amp;F : M) { errs() &lt;&lt; “I saw a function called” &lt;&lt; F.getName() &lt;&lt; “!”; for (auto &amp;B : F) { errs() &lt;&lt; “starting block”; errs() &lt;&lt; B &lt;&lt; “”; for (auto &amp;I : B) { errs() &lt;&lt; “instr:” &lt;&lt; I &lt;&lt; “”; } }; }; return PreservedAnalyses::all(); };</p>
<pre><code></code></pre>
<p>I saw a function called main! starting block</p>
<p>%3 = alloca i32, align 4 %4 = alloca i32, align 4 %5 = alloca i8<strong>, align 8 store i32 0, i32* %3, align 4 store i32 %0, i32* %4, align 4 store i8</strong> %1, i8*** %5, align 8 %6 = load i32, i32* %4, align 4 ret i32 %6</p>
<p>instr: %3 = alloca i32, align 4 instr: %4 = alloca i32, align 4 instr: %5 = alloca i8<strong>, align 8 instr: store i32 0, i32* %3, align 4 instr: store i32 %0, i32* %4, align 4 instr: store i8</strong> %1, i8*** %5, align 8 instr: %6 = load i32, i32* %4, align 4 instr: ret i32 %6</p>
<pre><code>

## modify the program 

find the first binary operator and change it to a multiply
</code></pre>
<p>#// temp.c int main(int argc, char **argv) { return argc + 5; }</p>
<pre><code>
``` PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;AM)
        {
            for (auto &amp;F : M)
            {
                errs() &lt;&lt; "I saw a function called " &lt;&lt; F.getName() &lt;&lt; "!\n";
                for (auto &amp;B : F)
                {
                    for (auto &amp;I : B)
                    {
                        if (isa&lt;BinaryOperator&gt;(&amp;I))
                        {
                            errs() &lt;&lt; "instr:" &lt;&lt; I &lt;&lt; "\n";
                        }
                        auto *op = dyn_cast&lt;BinaryOperator&gt;(&amp;I);
                        errs() &lt;&lt; "from_op:" &lt;&lt; op &lt;&lt; "\n";
                    }
                };
            };
            return PreservedAnalyses::all();
        }
   </code></pre>
<p>output</p>
<pre><code>I saw a function called main!
I saw a function called main!
from_op:0x0
from_op:0x0
from_op:0x0
from_op:0x0
from_op:0x0
from_op:0x0
from_op:0x0
instr:  %7 = add nsw i32 %6, 5
from_op:0xb58610
from_op:0x0</code></pre>
</section>
<section id="getting-analysis-info" class="level2">
<h2 class="anchored" data-anchor-id="getting-analysis-info">getting analysis info</h2>
<pre><code>   PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;MAM) {
        // Get the FunctionAnalysisManager.
        FunctionAnalysisManager &amp;FAM = MAM.getResult&lt;FunctionAnalysisManagerModuleProxy&gt;(M).getManager();

        for (Function &amp;F : M) {
            // Skip external functions.
            if (F.isDeclaration()) continue;

            // Get the DominatorTree for the function.
            DominatorTree &amp;DT = FAM.getResult&lt;DominatorTreeAnalysis&gt;(F);

            // Print the dominator tree.
            errs() &lt;&lt; "Dominator Tree for function: " &lt;&lt; F.getName() &lt;&lt; "\n";
            DT.print(errs());
        }</code></pre>
</section>
<section id="testing" class="level2">
<h2 class="anchored" data-anchor-id="testing">testing</h2>
<ol type="1">
<li>isa<argument>(V) true of V is a agument</argument></li>
<li>cast<argument>(V) casts to Argument, assert falure of not Argument</argument></li>
<li>dyn_cast<argument>(V) casts to Argument returns NULL if not an argument</argument></li>
</ol>
</section>
<section id="irbuilder" class="level2">
<h2 class="anchored" data-anchor-id="irbuilder">irbuilder</h2>
<pre><code>
 errs() &lt;&lt; "I saw a function called " &lt;&lt; F.getName() &lt;&lt; "!\n";
                for (auto &amp;B : F)
                {
                    errs() &lt;&lt; B &lt;&lt; "\n";

                    for (auto &amp;I : B)
                    {
                        if (auto *op = dyn_cast&lt;BinaryOperator&gt;(&amp;I))
                        {
                            errs() &lt;&lt; "old inst " &lt;&lt; *op &lt;&lt; "\n";
                            IRBuilder&lt;&gt; builder(op);
                            Value *left = op-&gt;getOperand(0);  // first operand
                            Value *right = op-&gt;getOperand(1); // second operad
                            Value *mul = builder.CreateMul(left, right);

                            errs() &lt;&lt; "new inst:" &lt;&lt; *mul &lt;&lt; "\n";

                            errs() &lt;&lt; B &lt;&lt; "\n";

                            // replace uses of op with mul
                            for (auto &amp;U : op-&gt;uses())
                            {
                                int num = U.getOperandNo(); // which argument
                                User *user = U.getUser();   // the instruction with the use
                                errs() &lt;&lt; " user:" &lt;&lt; *user &lt;&lt; "   ";
                                user-&gt;setOperand(num, mul);
                                errs() &lt;&lt; *user &lt;&lt; "\n";
                            }
                        }
                    }
                }
            };
 
             return PreservedAnalyses::none();</code></pre>
<p>output</p>
<p>I saw a function called main!</p>
<p>%3 = alloca i32, align 4 %4 = alloca i32, align 4 %5 = alloca i8<strong>, align 8 store i32 0, i32* %3, align 4 store i32 %0, i32* %4, align 4 store i8</strong> %1, i8*** %5, align 8 %6 = load i32, i32* %4, align 4 %7 = add nsw i32 %6, 5 ret i32 %7</p>
<p>old inst %7 = add nsw i32 %6, 5 new inst: %7 = mul i32 %6, 5</p>
<p>%3 = alloca i32, align 4 %4 = alloca i32, align 4 %5 = alloca i8<strong>, align 8 store i32 0, i32* %3, align 4 store i32 %0, i32* %4, align 4 store i8</strong> %1, i8*** %5, align 8 %6 = load i32, i32* %4, align 4 %7 = mul i32 %6, 5 %8 = add nsw i32 %6, 5 ret i32 %8</p>
<p>user: ret i32 %8 ret i32 %7</p>
<pre><code>

## more complex transforms -  for instrumentation  

instrumentation code in c not using builder 

insert calls to functions and link them in 

using IRBuilder is a mess, So I'm going to show a trick that makes it much simpler 

## chat gpt 

how do i write an instrumentation function in c for llvm, use a plugin pass to insert a call to the instrumentation routine

1. Write the Instrumentation Function in C: Create a C function that you want to call from your LLVM pass.
1. Create an LLVM Pass: Write an LLVM pass that inserts a call to the instrumentation function.
1. Build and Load the Pass: Compile the pass and load it using the opt tool or integrate it into your build system.

## instrumentation routine 
</code></pre>
<p>void instrument_function(const char* bb_name) { printf(“Instrumentation function called for basic block: %s”, bb_name); }</p>
<pre><code>

## pass
</code></pre>
<p>PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;MAM) { LLVMContext &amp;Ctx = M.getContext(); IRBuilder&lt;&gt; Builder(Ctx);</p>
<pre><code>    // Declare the instrumentation function as an external function
    FunctionType *FuncType = FunctionType::get(Type::getVoidTy(Ctx), Type::getInt8PtrTy(Cctx), false);
    FunctionCallee InstrumentFunc = M.getOrInsertFunction("instrument_function", FuncType);

    for (Function &amp;F : M) {

        // Insert the call at the beginning of each basic block
        for (BasicBlock &amp;BB : F) {
            Builder.SetInsertPoint(&amp;BB, BB.begin());

            // Create a global string for the basic block name
            Value *BBName = Builder.CreateGlobalStringPtr(BB.getName());

            // Create the call to the instrumentation function
            Builder.CreateCall(InstrumentFunc, BBName);
        }
    }

    return PreservedAnalyses::none();</code></pre>
<pre><code>
## starter code 

rm -r llvm-pass-skeleton
git clone  -b rtlib  https://github.com/sampsyo/llvm-pass-skeleton.git
cd llvm-pass-skeleton
mkdir -p build 
cd build 
cmake ..
make


## Adrians skeleton 
</code></pre>
<p>struct SkeletonPass : public PassInfoMixin<skeletonpass> { PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;AM) { for (auto &amp;F : M.functions()) {</skeletonpass></p>
<pre><code>        // Get the function to call from our runtime library.
        LLVMContext &amp;Ctx = F.getContext();
        std::vector&lt;Type*&gt; paramTypes = {Type::getInt32Ty(Ctx)};
        Type *retType = Type::getVoidTy(Ctx);
        FunctionType *logFuncType = FunctionType::get(retType, paramTypes, false);
        FunctionCallee logFunc =
            F.getParent()-&gt;getOrInsertFunction("logop", logFuncType);

        for (auto &amp;B : F) {
            for (auto &amp;I : B) {
                if (auto *op = dyn_cast&lt;BinaryOperator&gt;(&amp;I)) {
                    // Insert *after* `op`.
                    IRBuilder&lt;&gt; builder(op);
                    builder.SetInsertPoint(&amp;B, ++builder.GetInsertPoint());

                    // Insert a call to our function.
                    Value* args[] = {op};
                    builder.CreateCall(logFunc, args);

                    return PreservedAnalyses::none();
                }
            }
        }

    }
    return PreservedAnalyses::all();
}</code></pre>
<p>}; ``` #include &lt;stdio.h&gt; void logop(int i) { printf(“computed: %i”, i); }</p>
</section>
<section id="link-together" class="level2">
<h2 class="anchored" data-anchor-id="link-together">link together</h2>
<p>`` cd llvm-pass-skeleton cc -c rtlib.c — generates rtlib.o clang -fpass-plugin=build/skeleton/SkeletonPass.so -c test.cpp – generates test.o cc test.o rtlib.o – links it together ./a.out – runs it</p>


</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/normrubin\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../lectures/junk.html" class="pagination-link" aria-label="test">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">test</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../lectures/mem_consistancy.html" class="pagination-link" aria-label="memory consistancy">
        <span class="nav-page-text">memory consistancy</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://normrubin.github.io/">EECS 7398 website</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions"><ul><li><a href="https://github.com/normrubin/normrubin.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This page is built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>