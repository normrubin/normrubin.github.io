<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>local value numbering – EECE7398 Fall 2024</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../lectures/04_data_flow.html" rel="next">
<link href="../lectures/03_local.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-29e2c20b02301cfff04dc8050bf30c7e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-7916ee7d1825171c577c080daf967e67.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="local value numbering – EECE7398 Fall 2024">
<meta property="og:description" content="Homepage EECS7398 - Special Topic: Compilers, Fall 2024.">
<meta property="og:site_name" content="EECE7398 Fall 2024">
</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    <div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="revealjs_03b_local_value_numbering.qmd.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../weekly.html">EECS 7398</a></li><li class="breadcrumb-item"><a href="../lectures/010_compiler_overview.html">Lectures</a></li><li class="breadcrumb-item"><a href="../lectures/03b_local_value_numbering.html">local value numbering</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">local value numbering</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="local-value-numbering" class="level3">
<h3 class="anchored" data-anchor-id="local-value-numbering">Local Value Numbering</h3>
<p><a href="http://www.cs.cmu.edu/afs/cs/academic/class/15745-s19/www/">slides from Phil Gibbons at CMU</a> for more details and context on LVN</p>
<p>Value numbering is a very powerful technique that removes <strong><em>redundancies</em></strong>, An instruction x + y is redundant inside a block if it has already been computed in the block, and no intervening operation redefines x or y. If the compiler finds a redundant expression, it can save that value at the first computation and replace any subsequent evaluations with references to the saved value.</p>
<hr>
<p>The idea is simple - The algorithm executes the block, Each time it sees a new variable it gives it a value (represented as a number)</p>
<p>Each time it sees an instruction it forms a hash of the op code and the value numbers of its operands and gives it a new value number.</p>
<p>Two instructions are redundant if they have same op code and operands, which means the same value number</p>
<hr>
<p><span class="math inline">\(e_i\)</span> and <span class="math inline">\(e_j\)</span> have the same value number if and only if <span class="math inline">\(e_i\)</span> and <span class="math inline">\(e_j\)</span> are provably equal for all possible operands of the expressions.</p>
</section>
<section id="local-value-numbering-covers-lot-of-optimizations-that-look-different" class="level2">
<h2 class="anchored" data-anchor-id="local-value-numbering-covers-lot-of-optimizations-that-look-different">local value numbering covers lot of optimizations that look different</h2>
<pre><code>dead code elimination

main {
    a: int = const 100;
    a: int = const 42;
    print a;

}

copy propagation

main{
    x: int = const 4;
    copy1: int = id x;
    copy2: int = id copy1;
    print copy2;
}

common sub-expression elimination cse 

main {
    a: int = const 4;
    b: int = const 2;
    sum1: int = add a b;
    sum2: int = add a b;
    prod: int = mul sum1 sum2;
    print prod;
}</code></pre>
</section>
<section id="variables-vis-values" class="level2">
<h2 class="anchored" data-anchor-id="variables-vis-values">variables vis values</h2>
<p>We want to stop thinking about variables and think about values. Two instructions are redundant if they compute the same value.</p>
<hr>
<p>for example in a JIT compiler we want computation to be fast so we can get rid of all the variables</p>
<pre><code>b: int const 1;
c: int cont 2;
a:  int b c;  </code></pre>
<p>becomes:</p>
<pre><code>[  int const 1
   int const 2 
   int 0 1
]</code></pre>
<p>less storage, args are just pointers, instructions are smaller. faster because any use points to the corresponding def without any searching.</p>
<hr>
</section>
<section id="value-numbering-continued" class="level2">
<h2 class="anchored" data-anchor-id="value-numbering-continued">value numbering continued</h2>
</section>
<section id="use-of-turnt" class="level2">
<h2 class="anchored" data-anchor-id="use-of-turnt">use of turnt&nbsp;</h2>
<p><a href="https://www.cs.cornell.edu/~asampson/blog/turnt.html">turnt</a></p>
<p>there is a directory&nbsp; &nbsp;bril/examples/test/tdce&nbsp; &nbsp;which has some test programs&nbsp;</p>
<p>and a file turnt.toml&nbsp; that contains&nbsp; one line&nbsp;</p>
<p>command = “bril2json &lt; {filename} | python3 ../../tdce.py {args} | bril2txt”</p>
<p>to execute&nbsp;</p>
<p>(.venv) (base) norm@norm-ubuntu:~/bril/examples/test/tdce$ turnt *.bril 1..8 ok 1 - combo.bril ok 2 - diamond.bril ok 3 - double.bril ok 4 - double-pass.bril ok 5 - reassign.bril ok 6 - reassign-dkp.bril ok 7 - simple.bril ok 8 - skipped.bril</p>
</section>
<section id="redundancy-elimination" class="level2">
<h2 class="anchored" data-anchor-id="redundancy-elimination">redundancy elimination</h2>
<p>an expression x+y is redundant if and only if</p>
<ol type="1">
<li>along every path from the entry it has been evaluated and</li>
<li>its subexpressions x and y have not been redefined</li>
</ol>
<p>if the compiler can prove an expression is redundant it can</p>
<ol type="1">
<li>preserve the earlier evaluation</li>
<li>replace the redundant expression with a use of the preserved value</li>
</ol>
</section>
<section id="key-idea" class="level2">
<h2 class="anchored" data-anchor-id="key-idea">key idea</h2>
<p>assign a number (value number) to each expression</p>
<ol type="1">
<li>two expressions have the same value number if they always have the same value</li>
<li>use hashing to make this efficient</li>
</ol>
</section>
<section id="pseudo-code" class="level2">
<h2 class="anchored" data-anchor-id="pseudo-code">pseudo code</h2>
<p>walk each block, assign a distinct value number to each value the block computes.</p>
<p><span class="math inline">\(e_i\)</span> and <span class="math inline">\(e_j\)</span> have the same value number if and only if <span class="math inline">\(e_i\)</span> and <span class="math inline">\(e_j\)</span> are provably equal for all possible operands of the expressions.</p>
</section>
<section id="pseudo-code-vn-version-1" class="level2">
<h2 class="anchored" data-anchor-id="pseudo-code-vn-version-1">pseudo code vn version 1</h2>
<p>we have two tables - hash_table: expression to vn, variable holding the value variable to vn</p>
<pre><code>for each instr in the block
  v= [ value_number(a) for a in the args of the instr]
  build temp inst hash = instr.op + v
  if hash in hash_table:
     get from table vn, cann_variable 
     replace instr with instr.dest = cann_variable
     instr.dest = vn
  else: 
    generate a new value number, add new entry to hash_table, new vn, instr.dest </code></pre>
<p>An example</p>
<pre><code>a add b, c 
b sub a, d 
c add b, c
d sub a, d  // d id b</code></pre>
<pre><code>item   vn       hash 
b      0/4
c      1/5
                add12  2    a 
a      2 
d      3

                sub23 4     b
                add41 5     c
                </code></pre>
<p>Pseudo code (similar to an interpreter)</p>
<ol type="1">
<li><p>hash table constants and expressions of value numbers to value numbers and to a variable holding the value</p></li>
<li><p>reverse map from variables to value numbers</p></li>
</ol>
<hr>
<div class="columns">
<div class="column">
<pre><code>  main {
    a: int = const 4;
    b: int = const 2;
    sum1: int = add a b;
    sum2: int = add a b;
    prod: int = mult sum1 sum2;
    print prod

  }</code></pre>
</div><div class="column" style="font-size: 60%;">
<table class="caption-top table">
<thead>
<tr class="header">
<th>key</th>
<th>value</th>
<th>canonical name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>const 4</td>
<td>1</td>
<td>a</td>
</tr>
<tr class="even">
<td>const 2</td>
<td>2</td>
<td>b</td>
</tr>
<tr class="odd">
<td>add 1 2</td>
<td>3</td>
<td>sum1</td>
</tr>
<tr class="even">
<td>mul 3 3</td>
<td>4</td>
<td>prod</td>
</tr>
</tbody>
</table>
<table class="caption-top table">
<thead>
<tr class="header">
<th>name</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>a</td>
<td>1</td>
</tr>
<tr class="even">
<td>b</td>
<td>2</td>
</tr>
<tr class="odd">
<td>sum1</td>
<td>3</td>
</tr>
<tr class="even">
<td>sum2</td>
<td>3</td>
</tr>
<tr class="odd">
<td>prod</td>
<td>4</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>extensions:</p>
<ol type="1">
<li>a: int id b</li>
</ol>
<p>a gets the value number of b. No copy required</p>
<p>Commutative operations Commutative operations that differ only in the order of their operands, such as a × b and b × a, should receive the same value numbers. As lvn constructs a hash key for the right-hand side of the current operation, it can sort the operands using some convenient scheme, such as ordering them by value number. This simple action will ensure that commutative variants receive the same value number.</p>
<hr>
</section>
<section id="extension" class="level2">
<h2 class="anchored" data-anchor-id="extension">extension</h2>
<pre><code>constant folding 
   a: int const 1;
   b: int const 2;
   c: add a b;</code></pre>
<p>Constant folding If all the operands of an operation have known constant values, lvn can perform the operation and fold the answer directly into the code. lvn can store information about constants in the hash table, including their value. Before hash-key formation, it can test the operands and, if possible, evaluate them. If lvn discovers a constant expression, it can replace the operation with an immediate load of the result. Subsequent copy folding will clean up the code.</p>
<p>Algebraic identities: lvn can apply algebraic identities to simplify the code. For example, x + 0 and x should receive the same value number. Unfortunately, lvn needs special-case code for each identity. A series of tests, one per identity, can easily become long enough to produce an unacceptable slowdown in the algorithm. To ameliorate this problem, lvn should organize the tests into operator-specific decision trees.</p>
<p>a +0, a-0, a<em>1 a</em>0, a-a</p>
</section>
<section id="vn-version-2" class="level2">
<h2 class="anchored" data-anchor-id="vn-version-2">vn version 2</h2>
<p>add a bit indicating that a variable is a constant</p>
<pre><code>for each instr in the block
  v= [ value_number(a) for a in the args of the instr]
  if all v's are constants, fold the operation 
  check for all the identities 
  build temp inst hash = instr.op + v
  if hash in hash_table:
     get from table vn, cann_variable 
     replace instr with instr.dest = cann_variable
     instr.dest = vn
  else: 
    generate a new value number, add new entry to hash_table, new vn, instr.dest </code></pre>
</section>
<section id="problem" class="level2">
<h2 class="anchored" data-anchor-id="problem">problem:</h2>
<pre><code>a = x +y 
b = x + y
a = 17
c = x +y </code></pre>
<p>keep track of all variables that contain the value and select one</p>
<p>one option is to save the value, if x will be overwritten add a temp</p>
<pre><code>t = a+b
x = t 
x = 
  = t </code></pre>
</section>
<section id="another-option-is-renaming" class="level2">
<h2 class="anchored" data-anchor-id="another-option-is-renaming">another option is renaming</h2>
<div class="columns">
<div class="column">
<pre><code>a = x + y
b = x + y
a = 17
c = x +Y</code></pre>
</div><div class="column">
<pre><code>a0 = x0 + y0
b0 = x0+ y0
a1 = 17
c0 = x0 +y0</code></pre>
</div>
</div>
</section>
<section id="indirect-assignments" class="level2">
<h2 class="anchored" data-anchor-id="indirect-assignments">indirect assignments</h2>
<p>assignments via a pointer, or to an array element</p>
<pre><code>a = b[i]
...       no change to i 
c = b[i]


a = b[i]
i=
c = b[i]


a = b[i]
b[k] =
   =b[i]
   =b[k]</code></pre>
<p>indexed stores</p>
<p>when we see an assignment a[i] = exp</p>
<p>we have 3 value numbers a, i, exp</p>
<p>give the array a new value number give the array[i] operation the value number of the exp</p>
</section>
<section id="local-value-numbering." class="level2">
<h2 class="anchored" data-anchor-id="local-value-numbering.">Local value numbering.</h2>
<p>You can see one implementation in <code>lvn.py</code> in the Bril repository. But seriously, don’t be tempted! You want to write your implementation without looking at mine!</p>
<p><a href="https://github.com/normrubin/bril/tree/main/examples">examples</a></p>
</section>
<section id="testing-your-optimizations" class="level2">
<h2 class="anchored" data-anchor-id="testing-your-optimizations">Testing Your Optimizations</h2>
<p>As part of your tasks for this lesson, you will implement your first two optimizations. The two main things you want your optimizations to do are:</p>
<ol type="1">
<li>Not break programs.</li>
<li>Make programs faster, most of the time.</li>
</ol>
<hr>
<p>As with every task in this class, part of the work is checking that you have done what you set out to do — in this case, that your optimizations do those two things.</p>
<p>Think carefully about how to make a convincing case for each of those criteria.</p>
<hr>
<p>One tempting methodology might be to hand write a few small test-case Bril programs (or, worse, borrow the woefully inadequate ones sitting around in the Bril git repository), run them through your optimizations, and look at them to check whether they look right. This does not amount to convincing evidence (maybe you can think of a few specific reasons why).</p>
<hr>
<p>While there are many ways to be convincing, a pretty good way might be to run your optimization on *every single available <a href="https://capra.cs.cornell.edu/bril/tools/bench.html">Bril benchmark</a>, systematically check that it still produces the right output for at least one input, and collect aggregate statistics about some metric you’re interested in. This is a nice way to check for unexpected behavior in programs that you didn’t carefully write yourself to test the cases you’re thinking of.</p>
<hr>
<p>If this is the route you choose, you can do it however you like, There is a simple tool that you can consider using, called Brench. Brench is not very fancy; it does three things:</p>
<ol type="1">
<li><p>It makes it easy to run a long list of inputs through several different commands. (For example, you can run a long list of Bril benchmarks through an “interpret” command and an “optimize-and-then-interpret” command.)</p></li>
<li><p>It checks that all the commands agree on their output. (So, in our use case, it checks that optimizing the benchmark doesn’t change its output when interpreted.)</p></li>
<li><p>It can collect a statistic from each command for comparison. (Like the number of dynamic instructions the interpreter executed, which is a pretty good metric for standard optimizations.)</p></li>
</ol>
<p>Those three things are probably what you want to do to make a convincing case for an optimization’s correctness and effectiveness, whether or not you use Brench. It’s there if you want it, but feel free to go your own way!</p>
</section>
<section id="homework-2" class="level2">
<h2 class="anchored" data-anchor-id="homework-2">homework 2</h2>
<p>part 1: Implement “trivial” dead code elimination in which you delete instructions that are never used before they are reassigned.</p>
<p>part2: Implement local value numbering. Try pairing it with your dead code elimination code, in the write up be sure to include evidence that your implementation is correct and actually optimizes programs, you might want to use the Brench program, for extra points, extend your implementation to handle some of the tricker examples talked about in class.</p>
<p>remember that the result is a blog post</p>
</section>
<section id="crossing-blocks" class="level2">
<h2 class="anchored" data-anchor-id="crossing-blocks">crossing blocks</h2>
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>graph TB</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>A["m = a + b&lt;br&gt; n = a + b"]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>B["p = c + d&lt;br&gt;r = c + d"]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>C["q = a + b&lt;br&gt; r = c + d"]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>D["e = b + 18&lt;br&gt; s = a + b &lt;br&gt; u = e + f"]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>E["e = a + 17&lt;br&gt; t = c + d &lt;br&gt; u = e + f"]</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>F["v = a + b &lt;br&gt; w = c + d &lt;br&gt; x = e + f"]</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>G["y = a + b &lt;br&gt; z = c + d"]</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>style A fill:#ffffff,stroke:#000000,stroke-width:1px</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>style B fill:#ffffff,stroke:#000000,stroke-width:1px</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>style C fill:#ffffff,stroke:#000000,stroke-width:1px</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>style D fill:#ffffff,stroke:#000000,stroke-width:1px</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>style E fill:#ffffff,stroke:#000000,stroke-width:1px</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>style F fill:#ffffff,stroke:#000000,stroke-width:1px</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>style G fill:#ffffff,stroke:#000000,stroke-width:1px</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>A--&gt; B</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>A--&gt; C</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>C --&gt; D</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>C --&gt; E</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>D--&gt; F</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>E --&gt; F</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>F--&gt; G</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>B--&gt; G</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%

graph TB
A["m = a + b&lt;br&gt; n = a + b"]
B["p = c + d&lt;br&gt;r = c + d"]

C["q = a + b&lt;br&gt; r = c + d"]
D["e = b + 18&lt;br&gt; s = a + b &lt;br&gt; u = e + f"]
E["e = a + 17&lt;br&gt; t = c + d &lt;br&gt; u = e + f"]
F["v = a + b &lt;br&gt; w = c + d &lt;br&gt; x = e + f"]
G["y = a + b &lt;br&gt; z = c + d"]

style A fill:#ffffff,stroke:#000000,stroke-width:1px
style B fill:#ffffff,stroke:#000000,stroke-width:1px
style C fill:#ffffff,stroke:#000000,stroke-width:1px
style D fill:#ffffff,stroke:#000000,stroke-width:1px
style E fill:#ffffff,stroke:#000000,stroke-width:1px
style F fill:#ffffff,stroke:#000000,stroke-width:1px
style G fill:#ffffff,stroke:#000000,stroke-width:1px
A--&gt; B
A--&gt; C
C --&gt; D
C --&gt; E
D--&gt; F
E --&gt; F
F--&gt; G
B--&gt; G

</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="extended-basic-blocks" class="level2">
<h2 class="anchored" data-anchor-id="extended-basic-blocks">extended basic blocks</h2>
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>graph TB</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>A--&gt;b</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>A--&gt;c</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>c--&gt;d</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>c--&gt;e</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%

graph TB
A--&gt;b
A--&gt;c
c--&gt;d
c--&gt;e
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>how do we extend the hash tables over the boundary</p>
<p>we need to do value numbering over each path</p>
<pre><code>worklist = {entry block}
stack = {}
while worklist is not empty 
   remove a block b from the worklist 
   evn(b)

evn(b, stack)
   t = new table for b  
   link t above stack  
   lvn(b,t) 
   for each s successor of b,
     if s has one pred then evn(s, t)
     else add s to worklist 
   dealocate t</code></pre>
</section>
<section id="safety" class="level2">
<h2 class="anchored" data-anchor-id="safety">safety</h2>
<p>if the result of evaluating E1 cannot be distinguished from evaluating E the compiler is free to replace E with E1</p>
<p>Some compilers assume it is ok if E1 produces less errors than E</p>
<p>some compilers assume that safety is only required for “standard conforming” code and undefined behavior for other code.</p>
<p>Why is value numbering safe?</p>
<ol type="1">
<li>if an expression is in the hash table, it must have occurred at least one in the block</li>
<li>Algorithm modified the code but does not invalidate the table</li>
</ol>
</section>
<section id="when-is-value-numbering-profitable" class="level2">
<h2 class="anchored" data-anchor-id="when-is-value-numbering-profitable">when is value numbering profitable</h2>
<p>if reuse is cheaper then re-compute 1. does not cause a spill 1. if does not need a copy (does the copy take as long as the compute)</p>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/normrubin\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../lectures/03_local.html" class="pagination-link" aria-label="Local Analysis &amp; Optimization">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Local Analysis &amp; Optimization</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../lectures/04_data_flow.html" class="pagination-link" aria-label="Data Flow">
        <span class="nav-page-text">Data Flow</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://normrubin.github.io/">EECS 7398 website</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions"><ul><li><a href="https://github.com/normrubin/normrubin.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This page is built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>