<!DOCTYPE html>
<html lang="en"><head>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/tabby.min.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-29e2c20b02301cfff04dc8050bf30c7e.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.37">

  <title>EECE7398 Fall 2024 – Dynamic Compilers</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../site_libs/revealjs/dist/theme/quarto-bbe7401fe57d4b791b917637bb662036.css">
  <link href="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
  <script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
  <link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<meta property="og:title" content="Dynamic Compilers – EECE7398 Fall 2024">
<meta property="og:site_name" content="EECE7398 Fall 2024">
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Dynamic Compilers</h1>

<div class="quarto-title-authors">
</div>

</section>
<section id="jit-just-in-time-compilers-vs-aotahead-of-time-compilers" class="slide level2">
<h2>jit (just in time) compilers vs aot(ahead of time) compilers</h2>
<p>a jit compiler translates code into isa while the program executes</p>
<p>pro:</p>
<p>more information</p>
<p>con:</p>
<p>compile time slows down execution</p>
</section>
<section id="some-options" class="slide level2">
<h2>some options</h2>
<ul>
<li>compile a function the first time it is called</li>
<li>compile a function after it has been called a lot (needs an interpreter) We call these hot functions</li>
<li>build a trace of instructions executed and compile the hot traces (a trace has no branches)</li>
<li>A variation I used: ran the program to completion using a tracing interpreter, recompile off line, future execution is a mix of interpreter and compiled code</li>
</ul>
</section>
<section id="can-jit-compiled-code-run-faster-then-aot-code" class="slide level2">
<h2>Can jit compiled code run faster then aot code?</h2>
</section>
<section id="comparison" class="slide level2">
<h2>Comparison</h2>
<table class="caption-top">
<thead>
<tr class="header">
<th>aot</th>
<th>jit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>cannot inline libraries</td>
<td>can inline (even class methods)</td>
</tr>
<tr class="even">
<td>no runtime code gen</td>
<td>can use run time code gen</td>
</tr>
<tr class="odd">
<td>no speculative opts</td>
<td>can use spec opts</td>
</tr>
<tr class="even">
<td>less information</td>
<td>more information</td>
</tr>
<tr class="odd">
<td>overall performance lower</td>
<td>overall performance often higher</td>
</tr>
<tr class="even">
<td>full speed from the start</td>
<td>requires warmup</td>
</tr>
<tr class="odd">
<td>no compile cost at run time</td>
<td>overhead to run compiler</td>
</tr>
</tbody>
</table>
</section>
<section id="tradeoffs" class="slide level2 scrollable">
<h2>Tradeoffs</h2>
<ol type="1">
<li>The time to compile is part of the total execution time</li>
<li>might run less optimizations to speed up execution time</li>
<li>might look at run time info</li>
<li>same code might be compiled many times</li>
</ol>
<p>Why would the same code be compiled more than once?</p>
</section>
<section id="tiered-compilers" class="slide level2">
<h2>tiered compilers</h2>
<p>Since compilation is costly, do not compile functions that are only called once and do not contain a long running loop</p>
<p>we have a series of compilers, each with more aggressive optimization and each allowed to take longer</p>
<ul>
<li>the lowest tier is the interpreter</li>
<li>the next is the base line compiler</li>
</ul>
</section>
<section class="slide level2 scrollable">

<ol type="1">
<li>start interpreting the code</li>
<li>if some part of the code takes a long time, compile it with the next higher tier</li>
<li>is some runtime info changes, compile it again</li>
</ol>
</section>
<section id="magic-numbers" class="slide level2">
<h2>magic numbers</h2>
<p>associate a counter with branches and functions if the counter reaches some magic number use one of the compilers</p>
<p>if the counter for a backward branch, you recompile, but the code is executing in the middle of a loop, how do you insert the newly compiled code?</p>
</section>
<section id="questions-when-building-a-jit" class="slide level2">
<h2>questions when building a JIT</h2>
<ul>
<li>what strategy do you use to invoke the jit</li>
<li>do you have to execute for a while before calling the jit</li>
<li>how much info do you need</li>
<li>what is the price of wrong info</li>
<li>are there easy and hard programs</li>
<li>do the easy programs match up with users common programs</li>
</ul>
</section>
<section id="speculation" class="slide level2">
<h2>Speculation</h2>
<ul>
<li>assume some property is true, compile using that info this is always a gamble, so you need to recover if the assumption was wrong</li>
<li>assume a variable is an int, and does not overflow</li>
<li>assume properties of an object is fixed</li>
<li>assume the target of call is always the same</li>
<li>assume past behavior predicts future behavior</li>
</ul>
</section>
<section id="flow" class="slide level2">
<h2>flow</h2>
<div class="cell" data-reveal="true" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb1-1"><a></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb1-2"><a></a>graph LR</span>
<span id="cb1-3"><a></a>interpreter -- hot? --&gt; profiling </span>
<span id="cb1-4"><a></a>profiling -- stats --&gt; optimizing_compiler</span>
<span id="cb1-5"><a></a>optimizing_compiler --&gt; compiled_code</span>
<span id="cb1-6"><a></a>compiled_code -- deoptimze --&gt; interpreter</span>
<span id="cb1-7"><a></a>interpreter -- already_compiled --&gt; compiled_code</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph LR
interpreter -- hot? --&gt; profiling 
profiling -- stats --&gt; optimizing_compiler
optimizing_compiler --&gt; compiled_code
compiled_code -- deoptimze --&gt; interpreter
interpreter -- already_compiled --&gt; compiled_code
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="boxed-values" class="slide level2">
<h2>boxed values</h2>
<p>Many languages do not use strong static typing</p>
<p>for example in python</p>
<p>x = x + 1</p>
<p>x could be an int/float/object/string etc</p>
<p>the value of x needs to carry a type. Represent x as a pair (type, pointer or bits) The pair is called a boxed value</p>
<p>then to generate code for the plus we have to figure out what kind of add, based on the type</p>
</section>
<section id="inline-caches" class="slide level2">
<h2>inline caches</h2>
<p>in languages like python, calls to a method are more expensive then calls to a method in c++ why?</p>
<div class="fragment">
<p>Python objects are implemented as hash tables. While C++ uses virtual tables</p>
<p>how does that effect the cost?</p>
</div>
</section>
<section id="first-c-virtual-tables" class="slide level2 scrollable">
<h2>first C++ virtual tables</h2>
<p>in C++ a method call takes two dereferences</p>
<ol type="1">
<li>first find the v-table</li>
<li>second used a <strong><em>fixed offset</em></strong> from the table start to find the address</li>
</ol>
</section>
<section id="what-do-we-need-to-keep-the-offset-fixed" class="slide level2">
<h2>What do we need to keep the offset fixed?</h2>
<p>if derived inherits from base, and both have a function f. the offset to f has to be the same.</p>
<p>in languages where objects are hash tables, the c++ dereference becomes a hash table lookup, which is slower</p>
</section>
<section id="tradeoffs-1" class="slide level2">
<h2>tradeoffs</h2>
<p>In a dynamically typed language like python we can add or remove methods easily</p>
<p>but method calls are expensive</p>
<p>we want to make these calls cheaper</p>
</section>
<section id="inline-caches-at-each-call-site" class="slide level2">
<h2>inline caches at each call site</h2>
<p>the first time we call a method, we know the type (because we are generating code at runtime)</p>
<div class="columns">
<div class="column">
<pre><code>def func(a,b,c):
  for i in range(10):
     foo(a,b,c)</code></pre>
</div><div class="column">
<pre><code>def func(a,b,c):
  for i in range(10):
    if isinstance(a, type1)
      body of foo  
    else:
      other = lookup 'foo' in the hash
      call other(a,b,c
      )</code></pre>
</div></div>
</section>
<section id="inline-caches-at-the-function-site" class="slide level2">
<h2>inline caches at the function site</h2>
<div class="columns">
<div class="column" style="width:30%;">
<pre><code>def func(a,b,c):
  for i in range(10):
     _foo(a,b,c</code></pre>
</div><div class="column">
<pre><code>def _foo(a,b,c)
  if isinstance(a, type1)
      body of foo  
    else:
      other = lookup 'foo' in a
      call other(a,b,c)</code></pre>
</div></div>
<p>is it better to do this at the call site or at the function site?</p>
</section>
<section id="polymorphic-calls" class="slide level2">
<h2>polymorphic calls</h2>
<p>if the type changes at runtime (the call to other is taken) does the optimization help?</p>
<p>could invalidate the table and rebuild it with another case</p>
</section>
<section id="what-are-the-costs" class="slide level2">
<h2>what are the costs</h2>
<p>for example v8 compiler</p>
<p>monomorphic inline hit - 10 instructions</p>
<p>polymorphic hit - 35 instructions for 10 types, 60 instructions for 20 types</p>
<p>cache miss 1000-4000 instructions</p>
</section>
<section id="value-specialization" class="slide level2">
<h2>value specialization</h2>
<p>Oddly many functions are called with the same arguments</p>
</section>
<section id="an-example" class="slide level2">
<h2>an example</h2>
<p>given a vector v of size n, and a parameter q find the element of v that is closest to q</p>
<pre><code> function closest(v, q, n) {
    if (n == 0) {
          throw "Error";
    } else {
        var i = 0;
        var d = 0ffffffff;
        while (i &lt; n) {
           var nd = abs(v[i] - q);
           if (nd &lt;= d) d = nd; 
           i++;
        }    
        return d;  
      } 
}</code></pre>
</section>
<section id="the-cfg" class="slide level2">
<h2>the cfg</h2>
<p>we want to recompile this for specific v,q, and n, where we restart at the while test</p>
</section>
<section class="slide level2">

<div class="columns">
<div class="column" style="width:40%;">
<pre><code> function closest(v, q, n) {
    if (n == 0) {
          throw "Error";
    } else {
      var i = 0;
      var d = 0ffffffff;
      while (i &lt; n) {
         var nd = abs(v[i] - q);
         if (nd &lt;= d) d = nd; 
         i++;
        }    
        return d;  
      } 
}</code></pre>
</div><div class="column" style="width:40%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb8-1"><a></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb8-2"><a></a>graph TD</span>
<span id="cb8-3"><a></a>normal_entry["function entry</span>
<span id="cb8-4"><a></a>              v = param[0]</span>
<span id="cb8-5"><a></a>              q = param[1]</span>
<span id="cb8-6"><a></a>              n = param[2]</span>
<span id="cb8-7"><a></a>              if (n ==0) goto l1"]</span>
<span id="cb8-8"><a></a></span>
<span id="cb8-9"><a></a>l1["l1: throw error"]</span>
<span id="cb8-10"><a></a>l2[" l2: i0 = 0</span>
<span id="cb8-11"><a></a>     d = 0fffffff"]</span>
<span id="cb8-12"><a></a>normal_entry --&gt; l1</span>
<span id="cb8-13"><a></a>normal_entry--&gt; l2</span>
<span id="cb8-14"><a></a>l3["l3: i1 = phi(i0, i2, i3)</span>
<span id="cb8-15"><a></a>    d1 = phi(d0, d3, d4)</span>
<span id="cb8-16"><a></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb8-17"><a></a>l2--&gt; l3</span>
<span id="cb8-18"><a></a>entry_on_stack_rep["start replace</span>
<span id="cb8-19"><a></a>                   v = param[0]</span>
<span id="cb8-20"><a></a>                  q = param[1]</span>
<span id="cb8-21"><a></a>                  n = param[2]</span>
<span id="cb8-22"><a></a>                  i3 = stack[0]</span>
<span id="cb8-23"><a></a>                  d4 = stack[1]"]</span>
<span id="cb8-24"><a></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb8-25"><a></a>l5["l5: t0 = 4* i</span>
<span id="cb8-26"><a></a>     t1 = v[t0]</span>
<span id="cb8-27"><a></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb8-28"><a></a></span>
<span id="cb8-29"><a></a>l3 --&gt; l5 </span>
<span id="cb8-30"><a></a>l3--&gt; l4</span>
<span id="cb8-31"><a></a>l4["l4: return d1"]</span>
<span id="cb8-32"><a></a>l5--&gt; l7</span>
<span id="cb8-33"><a></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb8-34"><a></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb8-35"><a></a></span>
<span id="cb8-36"><a></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb8-37"><a></a>   i2 = i1 + 1</span>
<span id="cb8-38"><a></a>   goto l3"]</span>
<span id="cb8-39"><a></a>l7--&gt; l9</span>
<span id="cb8-40"><a></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb8-41"><a></a>l6--&gt; l9</span>
<span id="cb8-42"><a></a>l8["l8: throw boundsError"]</span>
<span id="cb8-43"><a></a>l5 --&gt; l8</span>
<span id="cb8-44"><a></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
normal_entry["function entry
              v = param[0]
              q = param[1]
              n = param[2]
              if (n ==0) goto l1"]

l1["l1: throw error"]
l2[" l2: i0 = 0
     d = 0fffffff"]
normal_entry --&gt; l1
normal_entry--&gt; l2
l3["l3: i1 = phi(i0, i2, i3)
    d1 = phi(d0, d3, d4)
    if (i1 &lt; n) go to l5"  ]
l2--&gt; l3
entry_on_stack_rep["start replace
                   v = param[0]
                  q = param[1]
                  n = param[2]
                  i3 = stack[0]
                  d4 = stack[1]"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="two-entries" class="slide level2">
<h2>two entries</h2>
<p>First entry is the regular starting point, second is the entry if we are currently running the loop in the interpreter</p>
<p>Since we are compiling the function while in the loop we can ask the interpreter for values</p>
<ul>
<li>v == load[0]</li>
<li>q = 42</li>
<li>n = 100</li>
<li>i = 40</li>
<li>d = 0fffffff</li>
</ul>
</section>
<section class="slide level2">

<div class="columns">
<div class="column" style="width:30%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb9-1"><a></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb9-2"><a></a>graph TD</span>
<span id="cb9-3"><a></a>normal_entry["function entry</span>
<span id="cb9-4"><a></a>              v = param[0]</span>
<span id="cb9-5"><a></a>              q = param[1]</span>
<span id="cb9-6"><a></a>              n = param[2]</span>
<span id="cb9-7"><a></a>              if (n ==0) goto l1"]</span>
<span id="cb9-8"><a></a></span>
<span id="cb9-9"><a></a>l1["l1: throw error"]</span>
<span id="cb9-10"><a></a>l2[" l2: i0 = 0</span>
<span id="cb9-11"><a></a>     d = 0fffffff"]</span>
<span id="cb9-12"><a></a>normal_entry --&gt; l1</span>
<span id="cb9-13"><a></a>normal_entry--&gt; l2</span>
<span id="cb9-14"><a></a>l3["l3: i1 = phi(i0, i2, i3)</span>
<span id="cb9-15"><a></a>    d1 = phi(d0, d3, d4)</span>
<span id="cb9-16"><a></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb9-17"><a></a>l2--&gt; l3</span>
<span id="cb9-18"><a></a>entry_on_stack_rep["start replace</span>
<span id="cb9-19"><a></a>                   v = param[0]</span>
<span id="cb9-20"><a></a>                  q = param[1]</span>
<span id="cb9-21"><a></a>                  n = param[2]</span>
<span id="cb9-22"><a></a>                  i3 = stack[0]</span>
<span id="cb9-23"><a></a>                  d4 = stack[1]"]</span>
<span id="cb9-24"><a></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb9-25"><a></a>l5["l5: t0 = 4* i</span>
<span id="cb9-26"><a></a>     t1 = v[t0]</span>
<span id="cb9-27"><a></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb9-28"><a></a></span>
<span id="cb9-29"><a></a>l3 --&gt; l5 </span>
<span id="cb9-30"><a></a>l3--&gt; l4</span>
<span id="cb9-31"><a></a>l4["l4: return d1"]</span>
<span id="cb9-32"><a></a>l5--&gt; l7</span>
<span id="cb9-33"><a></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb9-34"><a></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb9-35"><a></a></span>
<span id="cb9-36"><a></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb9-37"><a></a>   i2 = i1 + 1</span>
<span id="cb9-38"><a></a>   goto l3"]</span>
<span id="cb9-39"><a></a>l7--&gt; l9</span>
<span id="cb9-40"><a></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb9-41"><a></a>l6--&gt; l9</span>
<span id="cb9-42"><a></a>l8["l8: throw boundsError"]</span>
<span id="cb9-43"><a></a>l5 --&gt; l8</span>
<span id="cb9-44"><a></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
normal_entry["function entry
              v = param[0]
              q = param[1]
              n = param[2]
              if (n ==0) goto l1"]

l1["l1: throw error"]
l2[" l2: i0 = 0
     d = 0fffffff"]
normal_entry --&gt; l1
normal_entry--&gt; l2
l3["l3: i1 = phi(i0, i2, i3)
    d1 = phi(d0, d3, d4)
    if (i1 &lt; n) go to l5"  ]
l2--&gt; l3
entry_on_stack_rep["start replace
                   v = param[0]
                  q = param[1]
                  n = param[2]
                  i3 = stack[0]
                  d4 = stack[1]"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div><div class="column" style="width:40%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb10-1"><a></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb10-2"><a></a>graph TD</span>
<span id="cb10-3"><a></a>normal_entry["function entry</span>
<span id="cb10-4"><a></a>              v = load[0]</span>
<span id="cb10-5"><a></a>              q = q = 42 </span>
<span id="cb10-6"><a></a>              n = 100</span>
<span id="cb10-7"><a></a>              if (n ==0) goto l1"]</span>
<span id="cb10-8"><a></a></span>
<span id="cb10-9"><a></a>l1["l1: throw error"]</span>
<span id="cb10-10"><a></a>l2[" l2: i0 = 0</span>
<span id="cb10-11"><a></a>     d = 0fffffff"]</span>
<span id="cb10-12"><a></a>normal_entry --&gt; l1</span>
<span id="cb10-13"><a></a>normal_entry--&gt; l2</span>
<span id="cb10-14"><a></a>l3["l3: i1 = phi(i2, i3)</span>
<span id="cb10-15"><a></a>    d1 = phi(d3, d4)</span>
<span id="cb10-16"><a></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb10-17"><a></a>l2--&gt; l3</span>
<span id="cb10-18"><a></a>entry_on_stack_rep["start replace</span>
<span id="cb10-19"><a></a>                   v = load [0]</span>
<span id="cb10-20"><a></a>                  q = 42</span>
<span id="cb10-21"><a></a>                  n = 100</span>
<span id="cb10-22"><a></a>                  i3 = 40</span>
<span id="cb10-23"><a></a>                  d4 = offfffff"]</span>
<span id="cb10-24"><a></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb10-25"><a></a>l5["l5: t0 = 4* i</span>
<span id="cb10-26"><a></a>     t1 = v[t0]</span>
<span id="cb10-27"><a></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb10-28"><a></a></span>
<span id="cb10-29"><a></a>l3 --&gt; l5 </span>
<span id="cb10-30"><a></a>l3--&gt; l4</span>
<span id="cb10-31"><a></a>l4["l4: return d1"]</span>
<span id="cb10-32"><a></a>l5--&gt; l7</span>
<span id="cb10-33"><a></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb10-34"><a></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb10-35"><a></a></span>
<span id="cb10-36"><a></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb10-37"><a></a>   i2 = i1 + 1</span>
<span id="cb10-38"><a></a>   goto l3"]</span>
<span id="cb10-39"><a></a>l7--&gt; l9</span>
<span id="cb10-40"><a></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb10-41"><a></a>l6--&gt; l9</span>
<span id="cb10-42"><a></a>l8["l8: throw boundsError"]</span>
<span id="cb10-43"><a></a>l5 --&gt; l8</span>
<span id="cb10-44"><a></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
normal_entry["function entry
              v = load[0]
              q = q = 42 
              n = 100
              if (n ==0) goto l1"]

l1["l1: throw error"]
l2[" l2: i0 = 0
     d = 0fffffff"]
normal_entry --&gt; l1
normal_entry--&gt; l2
l3["l3: i1 = phi(i2, i3)
    d1 = phi(d3, d4)
    if (i1 &lt; n) go to l5"  ]
l2--&gt; l3
entry_on_stack_rep["start replace
                   v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="dead-code-elimination" class="slide level2">
<h2>dead code elimination</h2>
<p>After this all calls to the function assume these arguments so no need to keep the regular entry</p>
<div class="columns">
<div class="column" style="width:30%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb11-1"><a></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb11-2"><a></a>graph TD</span>
<span id="cb11-3"><a></a>normal_entry["function entry</span>
<span id="cb11-4"><a></a>              v = load[0]</span>
<span id="cb11-5"><a></a>              q = q = 42 </span>
<span id="cb11-6"><a></a>              n = 100</span>
<span id="cb11-7"><a></a>              if (n ==0) goto l1"]</span>
<span id="cb11-8"><a></a></span>
<span id="cb11-9"><a></a>l1["l1: throw error"]</span>
<span id="cb11-10"><a></a>l2[" l2: i0 = 0</span>
<span id="cb11-11"><a></a>     d = 0fffffff"]</span>
<span id="cb11-12"><a></a>normal_entry --&gt; l1</span>
<span id="cb11-13"><a></a>normal_entry--&gt; l2</span>
<span id="cb11-14"><a></a>l3["l3: i1 = phi(i2, i3)</span>
<span id="cb11-15"><a></a>    d1 = phi(d3, d4)</span>
<span id="cb11-16"><a></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb11-17"><a></a>l2--&gt; l3</span>
<span id="cb11-18"><a></a>entry_on_stack_rep["start replace</span>
<span id="cb11-19"><a></a>                   v = load [0]</span>
<span id="cb11-20"><a></a>                  q = 42</span>
<span id="cb11-21"><a></a>                  n = 100</span>
<span id="cb11-22"><a></a>                  i3 = 40</span>
<span id="cb11-23"><a></a>                  d4 = offfffff"]</span>
<span id="cb11-24"><a></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb11-25"><a></a>l5["l5: t0 = 4* i</span>
<span id="cb11-26"><a></a>     t1 = v[t0]</span>
<span id="cb11-27"><a></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb11-28"><a></a></span>
<span id="cb11-29"><a></a>l3 --&gt; l5 </span>
<span id="cb11-30"><a></a>l3--&gt; l4</span>
<span id="cb11-31"><a></a>l4["l4: return d1"]</span>
<span id="cb11-32"><a></a>l5--&gt; l7</span>
<span id="cb11-33"><a></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb11-34"><a></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb11-35"><a></a></span>
<span id="cb11-36"><a></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb11-37"><a></a>   i2 = i1 + 1</span>
<span id="cb11-38"><a></a>   goto l3"]</span>
<span id="cb11-39"><a></a>l7--&gt; l9</span>
<span id="cb11-40"><a></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb11-41"><a></a>l6--&gt; l9</span>
<span id="cb11-42"><a></a>l8["l8: throw boundsError"]</span>
<span id="cb11-43"><a></a>l5 --&gt; l8</span>
<span id="cb11-44"><a></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
normal_entry["function entry
              v = load[0]
              q = q = 42 
              n = 100
              if (n ==0) goto l1"]

l1["l1: throw error"]
l2[" l2: i0 = 0
     d = 0fffffff"]
normal_entry --&gt; l1
normal_entry--&gt; l2
l3["l3: i1 = phi(i2, i3)
    d1 = phi(d3, d4)
    if (i1 &lt; n) go to l5"  ]
l2--&gt; l3
entry_on_stack_rep["start replace
                   v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div><div class="column" style="width:45%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb12-1"><a></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb12-2"><a></a>graph TD</span>
<span id="cb12-3"><a></a></span>
<span id="cb12-4"><a></a>l3["l3: i1 = phi(i2, i3)</span>
<span id="cb12-5"><a></a>    d1 = phi(dd3, d4)</span>
<span id="cb12-6"><a></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb12-7"><a></a>entry_on_stack_rep["start replace</span>
<span id="cb12-8"><a></a>                   v = load [0]</span>
<span id="cb12-9"><a></a>                  q = 42</span>
<span id="cb12-10"><a></a>                  n = 100</span>
<span id="cb12-11"><a></a>                  i3 = 40</span>
<span id="cb12-12"><a></a>                  d4 = offfffff"]</span>
<span id="cb12-13"><a></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb12-14"><a></a>l5["l5: t0 = 4* i</span>
<span id="cb12-15"><a></a>     t1 = v[t0]</span>
<span id="cb12-16"><a></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb12-17"><a></a></span>
<span id="cb12-18"><a></a>l3 --&gt; l5 </span>
<span id="cb12-19"><a></a>l3--&gt; l4</span>
<span id="cb12-20"><a></a>l4["l4: return d1"]</span>
<span id="cb12-21"><a></a>l5--&gt; l7</span>
<span id="cb12-22"><a></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb12-23"><a></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb12-24"><a></a></span>
<span id="cb12-25"><a></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb12-26"><a></a>   i2 = i1 + 1</span>
<span id="cb12-27"><a></a>   goto l3"]</span>
<span id="cb12-28"><a></a>l7--&gt; l9</span>
<span id="cb12-29"><a></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb12-30"><a></a>l6--&gt; l9</span>
<span id="cb12-31"><a></a>l8["l8: throw boundsError"]</span>
<span id="cb12-32"><a></a>l5 --&gt; l8</span>
<span id="cb12-33"><a></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD

l3["l3: i1 = phi(i2, i3)
    d1 = phi(dd3, d4)
    if (i1 &lt; n) go to l5"  ]
entry_on_stack_rep["start replace
                   v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="array-in-bounds-check" class="slide level2">
<h2>array in bounds check</h2>
<p>we can pattern match loops with bounds checks if we know the limit</p>
</section>
<section class="slide level2">

<div class="columns">
<div class="column" style="width:30%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb13-1"><a></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb13-2"><a></a>graph TD</span>
<span id="cb13-3"><a></a></span>
<span id="cb13-4"><a></a>l3["l3: i1 = phi(i2, i3)</span>
<span id="cb13-5"><a></a>    d1 = phi(dd3, d4)</span>
<span id="cb13-6"><a></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb13-7"><a></a>entry_on_stack_rep["start replace</span>
<span id="cb13-8"><a></a>                   v = load [0]</span>
<span id="cb13-9"><a></a>                  q = 42</span>
<span id="cb13-10"><a></a>                  n = 100</span>
<span id="cb13-11"><a></a>                  i3 = 40</span>
<span id="cb13-12"><a></a>                  d4 = offfffff"]</span>
<span id="cb13-13"><a></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb13-14"><a></a>l5["l5: t0 = 4* i</span>
<span id="cb13-15"><a></a>     t1 = v[t0]</span>
<span id="cb13-16"><a></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb13-17"><a></a></span>
<span id="cb13-18"><a></a>l3 --&gt; l5 </span>
<span id="cb13-19"><a></a>l3--&gt; l4</span>
<span id="cb13-20"><a></a>l4["l4: return d1"]</span>
<span id="cb13-21"><a></a>l5--&gt; l7</span>
<span id="cb13-22"><a></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb13-23"><a></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb13-24"><a></a></span>
<span id="cb13-25"><a></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb13-26"><a></a>   i2 = i1 + 1</span>
<span id="cb13-27"><a></a>   goto l3"]</span>
<span id="cb13-28"><a></a>l7--&gt; l9</span>
<span id="cb13-29"><a></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb13-30"><a></a>l6--&gt; l9</span>
<span id="cb13-31"><a></a>l8["l8: throw boundsError"]</span>
<span id="cb13-32"><a></a>l5 --&gt; l8</span>
<span id="cb13-33"><a></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD

l3["l3: i1 = phi(i2, i3)
    d1 = phi(dd3, d4)
    if (i1 &lt; n) go to l5"  ]
entry_on_stack_rep["start replace
                   v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div><div class="column" style="width:45;">
<div class="cell" data-reveal="true" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb14-1"><a></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb14-2"><a></a>graph TD</span>
<span id="cb14-3"><a></a></span>
<span id="cb14-4"><a></a>l3["l3: i1 = phi(i0, i2, i3)</span>
<span id="cb14-5"><a></a>    d1 = phi(d0, d3, d4)</span>
<span id="cb14-6"><a></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb14-7"><a></a>entry_on_stack_rep["start replace</span>
<span id="cb14-8"><a></a>                   v = load [0]</span>
<span id="cb14-9"><a></a>                  q = 42</span>
<span id="cb14-10"><a></a>                  n = 100</span>
<span id="cb14-11"><a></a>                  i3 = 40</span>
<span id="cb14-12"><a></a>                  d4 = offfffff"]</span>
<span id="cb14-13"><a></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb14-14"><a></a>l5["l5: t0 = 4* i</span>
<span id="cb14-15"><a></a>     t1 = v[t0]</span>
<span id="cb14-16"><a></a>     "]</span>
<span id="cb14-17"><a></a></span>
<span id="cb14-18"><a></a>l3 --&gt; l5 </span>
<span id="cb14-19"><a></a>l3--&gt; l4</span>
<span id="cb14-20"><a></a>l4["l4: return d1"]</span>
<span id="cb14-21"><a></a>l5--&gt; l7</span>
<span id="cb14-22"><a></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb14-23"><a></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb14-24"><a></a></span>
<span id="cb14-25"><a></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb14-26"><a></a>   i2 = i1 + 1</span>
<span id="cb14-27"><a></a>   goto l3"]</span>
<span id="cb14-28"><a></a>l7--&gt; l9</span>
<span id="cb14-29"><a></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb14-30"><a></a>l6--&gt; l9</span>
<span id="cb14-31"><a></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD

l3["l3: i1 = phi(i0, i2, i3)
    d1 = phi(d0, d3, d4)
    if (i1 &lt; n) go to l5"  ]
entry_on_stack_rep["start replace
                   v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     "]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="loop-inversion" class="slide level2">
<h2>loop inversion</h2>
<p>a general while loop, loop might never run so cannot move code out of the loop</p>
<pre><code>while(cond){
  ...
}</code></pre>
<p>can be changed into</p>
<pre><code>if (cond){
  do {
    ...
  } while(cond)
}</code></pre>
<p>for this loop the first time around i = 40, n = 100 so the first condition is true</p>
</section>
<section id="after-loop-inversion" class="slide level2">
<h2>after loop inversion</h2>
<div class="cell" data-reveal="true" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb17-1"><a></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb17-2"><a></a>graph TD</span>
<span id="cb17-3"><a></a>l3["l3: i1 = phi(i2, i3)</span>
<span id="cb17-4"><a></a>    d1 = phi(d3, d4)" ]</span>
<span id="cb17-5"><a></a>entry_on_stack_rep["v = load [0]</span>
<span id="cb17-6"><a></a>                  q = 42</span>
<span id="cb17-7"><a></a>                  n = 100</span>
<span id="cb17-8"><a></a>                  i3 = 40</span>
<span id="cb17-9"><a></a>                  d4 = offfffff"]</span>
<span id="cb17-10"><a></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb17-11"><a></a>l3 --&gt; l7</span>
<span id="cb17-12"><a></a></span>
<span id="cb17-13"><a></a></span>
<span id="cb17-14"><a></a>l4["l4: return d1"]</span>
<span id="cb17-15"><a></a>l7[" l7: l5: t0 = 4* i</span>
<span id="cb17-16"><a></a>t1 = v[t0]</span>
<span id="cb17-17"><a></a>nd = abs(t1, q)</span>
<span id="cb17-18"><a></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb17-19"><a></a></span>
<span id="cb17-20"><a></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb17-21"><a></a>   i2 = i1 + 1</span>
<span id="cb17-22"><a></a>   if (i2 &gt; n) goto l4"]</span>
<span id="cb17-23"><a></a>l7--&gt; l9</span>
<span id="cb17-24"><a></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb17-25"><a></a>l6--&gt; l9</span>
<span id="cb17-26"><a></a>l9--&gt; l3</span>
<span id="cb17-27"><a></a>l9--&gt; l4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
l3["l3: i1 = phi(i2, i3)
    d1 = phi(d3, d4)" ]
entry_on_stack_rep["v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l3 --&gt; l7


l4["l4: return d1"]
l7[" l7: l5: t0 = 4* i
t1 = v[t0]
nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   if (i2 &gt; n) goto l4"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l9--&gt; l3
l9--&gt; l4
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="results" class="slide level2">
<h2>results</h2>
<p>specialized code is shorter and compiles faster</p>
<p>since we know that the loop goes from 42 to 100, we could unroll the loop</p>
</section>
<section id="dynamic-compilation-and-pgo-profile-guided-optimization" class="slide level2">
<h2>dynamic compilation and pgo (profile guided optimization)</h2>
<p>workload dependent – dynamically you only measure what you actually see – that can lead to sub-optimal choices if you make them “forever”</p>
<p>If your program has phases, where it does some kind of behavior for a while, and then shifts to another behavior afterwards, then that workload that you originally measured isn’t representative anymore!</p>
<p>When you do PGO you’re supposed to do it on the entire program and it’s supposed to be representative, whereas when you’re tracing you’re doing that live!</p>
</section>
<section id="confidence-vs-time" class="slide level2">
<h2>confidence vs time</h2>
<p>set the magic numbers high- run a long time slowly, but gather more info</p>
<p>set the magic number low, quickly recompile based on less info</p>
</section>
<section>
<section id="dynamic-compilers-part-2" class="title-slide slide level1 center">
<h1>Dynamic Compilers part 2</h1>

</section>
<section id="c-method-call" class="slide level2 scrollable">
<h2>C++ method call</h2>
<p>each object has a pointer to a vtable, which is a table of function pointers to all the virtual functions</p>
<p>each derived object has its own vtable, which has the same offsets for all the common virtual functions</p>
<p>to find the code takes two dereferences</p>
<ol type="1">
<li>find the vtable (one per class) (one load)</li>
<li>at a fixed offset (determined by the virtual function name) find the code (second load)</li>
</ol>
</section>
<section id="a-python-example" class="slide level2 scrollable">
<h2>a python example</h2>
<p>more flexible</p>
<ol type="1">
<li>find the hash table (one per instance)</li>
<li>lookup the virtual function in the hash table</li>
</ol>
<pre><code>
class Thing:
    def __init__(self, kind):
        self.kind = kind 

thing = Thing('car')

def honk(self):
    print(f"{self.kind} says Honk")

thing.honk = honk.__get__(thing)  ## add a method dynamically to one instance 

thing.honk()  ## call it 
</code></pre>
<p>honk.__get__(thing) returns a bound method, when this method is called thing is passed as first argument</p>
</section>
<section id="dynamic-chunks" class="slide level2 scrollable">
<h2>dynamic chunks</h2>
<p>So far:</p>
<ol type="1">
<li>run interpreter or tier 0 compiler</li>
<li>collect statistics on call counts or branch counts</li>
<li>when count is high enough recompile the hot functions</li>
<li>specialize the hot functions based on common values</li>
</ol>
</section>
<section id="the-unit-of-compilation-is-the-static-function" class="slide level2 scrollable">
<h2>The unit of compilation is the static function</h2>
<p>an alterative is called <strong><em>trace compilation</em></strong></p>
<ol type="1">
<li>run interpreter or tier 0 compiler</li>
<li>collect the statements executed (no not collect control flow)</li>
<li>this produces a linear trace of instructions</li>
<li>recompile the trace using optimizations like value numbering</li>
<li>if the next time the code executes, it takes a different path, fix things up</li>
</ol>
</section>
<section id="trace-compilation-0" class="slide level2">
<h2>trace compilation 0</h2>
<p>In a linear trace the number of assumptions you’re making accumulates as you execute [towards the end of the trace you have the most assumptions built up]</p>
<p>If you have an always-taken control flow, e.g.&nbsp;some virtual function call that’s always calling the same actual function, a tracing compiler will treat all back-to-back branches as one set of straight line code</p>
<p>execute this all back to back, and, whenever convenient, check whether any of those assumptions were wrong”</p>
</section>
<section id="cold-path" class="slide level2">
<h2>cold path</h2>
<p>On the “cold path” – again, when it’s convenient undo all the inapplicable things if it turns out the branches weren’t true</p>
<p>Called a “bailout” [“bailing out” of the trace]</p>
<p>At a bailout there is new information. something you didn’t observe when you were tracing</p>
<p>You trust that everything you’ve trace is going to happen, it’s all going to well, and you’re going to be able to optimize for it</p>
<p>But then at runtime, when convenient, you’re going to check, and then bail if you were wrong, and have the rollback on the cold path</p>
<p>So the hot path, the one you’re pretty sure is going to execute, is quite optimal</p>
</section>
<section id="trace-compilation-2" class="slide level2">
<h2>trace compilation 2</h2>
<p>tracing jit: extract a hot path (not a function)</p>
<p>Hot paths are compiled as a single basic block, but the path might go through a call</p>
<p>gamble: next execution starting at this point, go the same way, no branches leave the path</p>
<p>generate machine code for hot paths interpret the rest of the program</p>
<p>unlike specialization, tracing assumes the same path but not the same values</p>
</section>
<section id="an-example-x-42" class="slide level2">
<h2>an example (x = 42)</h2>
<div class="columns">
<div class="column">
<pre><code>function main(x){
   y = x +1 
   if x &lt;100 {
      z = f(y)
   } else {
      z = g(y)
   }
   return z
}

function f(a){
   return a -1 
}</code></pre>
</div><div class="column">
<div>
<ul>
<li class="fragment">y = x +1</li>
<li class="fragment">guard(x &lt; 100)</li>
<li class="fragment">a = y</li>
<li class="fragment">z = a - 1</li>
<li class="fragment">return z</li>
</ul>
</div>
</div></div>
<p>guards at divergence, guards never return</p>
<p>optimize assuming guards are true, ok to be slow if guard is false</p>
</section>
<section id="move-guards-up" class="slide level2">
<h2>move guards up</h2>
<p>why is this a good idea?</p>
<div class="fragment">
<ul>
<li>fail fast</li>
<li>longer region to optimize</li>
</ul>
</div>
</section>
<section id="use-local-value-numbering" class="slide level2">
<h2>use local value numbering</h2>
<div class="columns">
<div class="column">
<ul>
<li>guard(x &lt; 100)</li>
<li>y = x + 1</li>
<li>a = y</li>
<li>z = a - 1</li>
<li>return z</li>
</ul>
</div><div class="column">
<ul>
<li>guard(x &lt; 100)</li>
<li>return x</li>
</ul>
</div></div>
</section>
<section id="how-do-this-in-bril" class="slide level2 scrollable">
<h2>how do this in Bril?</h2>
<p>3 new operations (sort of like out-of-order instructions)</p>
<ol type="1">
<li>speculate - Enter a speculative execution context. No arguments.</li>
<li>commit - End the current speculative context, committing the current speculative state as the “real” state. No arguments.</li>
<li>guard - Check a condition and possibly abort the current speculative context. One argument, the Boolean condition, and one label, to which control is transferred on abort.</li>
</ol>
</section>
<section id="speculate-extension" class="slide level2">
<h2>speculate extension</h2>
<p><a href="https://github.com/sampsyo/bril/blob/main/docs/lang/spec.md">speculative execution extension</a></p>
</section>
<section id="example" class="slide level2">
<h2>example</h2>
<p>b: bool = const false;</p>
<p>v: int = const 4; v == 4<br>
speculate; v: int = const 2; v == 2 (speculate state) guard b .failed; v == 2 (speculate state) commit;</p>
<p>.failed: print v; v == 4</p>
</section>
<section id="implementation" class="slide level2">
<h2>implementation</h2>
<p>you can add a tracer to an interpreter</p>
<p>In a lot of language environments you’ll have an interpreter that’s executing “op at a time”</p>
<p>hook in a tracer which observes what the interpreter is doing and “make some machine code on the side” based on how the interpreter ran</p>
<p>you can implement just a subset of the operations [ed: you might call this property “compiler completeness” for your op set</p>
</section>
<section id="common-bytecode-operations" class="slide level2">
<h2>common bytecode operations</h2>
<p>implement only the common ones and simply end the trace when you hit one that was not implemented, because it was uncommon</p>
<p>You can build up this trace JIT-ing capability over time, because the system is built with this assumption you can bail out of the trace for whatever reason and go back to thr interpreter</p>
</section>
<section id="an-example-1" class="slide level2">
<h2>an example</h2>
<p>Could imagine making a JIT that just: Covered MULs and ADDs and could make fused/composite MUL/ADD bytecode combinations</p>
<p>Specialize that for one common type; e.g.&nbsp;if you have many types in your language, could support that just for integer types, or just for FP ops e.g.&nbsp;if it were numerical code, and then just bail if any other types showed up at runtime;</p>
<p>trace invariants: suppose traces call to other traces;</p>
<p>trace1 set of ops A, trace2 with set of ops B and we see a transfer from A to B</p>
<p>make sure that the assumptions between those two things are lining up – called <strong><em>trace fusion</em></strong></p>
<p>know the invariants (i.e.&nbsp;“what must be true”) on the exit from A and the entry to B are lining up / compatible with each other</p>
</section>
<section id="method-inlining" class="slide level2">
<h2>method inlining</h2>
<p>In trace compiler you just execute through methods</p>
<p>Inlining kind of the natural path of compilation when doing trace compilation – just linear execution where the jumps/calls/returns simply disappear</p>
</section>
<section id="tail-duplication" class="slide level2">
<h2>tail duplication</h2>
<p>it is common that multiple traces have a common tail</p>
<pre><code>for() {
  if op_Eq{
     op1 
   } else {
      op2
   }
}
op_t
op_a
op_i
op_l</code></pre>
<pre><code>trace0:  op_eq quard\true  op1 op_t op_a op_i op_l 

trace1:              \false op2 op_t op_a op_i op_l </code></pre>
<p>two traces with the same ending, could generate</p>
<p>one copy of the tail- with arguments showing the header</p>
<p>two copies of the tail- frozen header</p>
</section>
<section id="adding-traces-to-bril" class="slide level2 scrollable">
<h2>adding traces to bril</h2>
<p>How to modify the reference interpreter (warning typescript!)</p>
<p><a href="https://github.com/sampsyo/bril/blob/main/brili.ts">brili</a></p>
<p>there are two functions to consider</p>
<ol type="1">
<li>evalFunc interprets a function by calling evalInstr on each instruction</li>
<li>evalInstr interprets one instruction, large case statement for each instruction</li>
</ol>
</section>
<section id="print-instructions-as-they-execute" class="slide level2 scrollable">
<h2>print instructions as they execute</h2>
<ol type="1">
<li>figure out when to start and when to stop</li>
<li>how to print instructions (modify evalInstr by printing instructions) console.log(instr)</li>
</ol>
<p>you have to optimize the trace and put it back</p>
</section>
<section id="traces-and-users" class="slide level2">
<h2>traces and users</h2>
<p>when a trace works well- it looks amazing - it finds the inner loop and optimizes even through libraries</p>
<p>but users find in hard to understand what the compiler did,</p>
<p>a tiny source change can make a big trace change</p>
<p>hard to fit in a debugger</p>
<p>security is a problem</p>
</section>
<section id="pytorch-2.0" class="slide level2">
<h2>pytorch 2.0</h2>
<p>ml frameworks have two modes</p>
</section>
<section id="eager-mode" class="slide level2">
<h2>Eager Mode</h2>
<ul>
<li>Preferred by users</li>
<li>Easier to use programming model</li>
<li>Easy to debug</li>
</ul>
<p>a + b + c executes two calls to torch.add (if they are tensors)</p>
<p>no place to optimize, allows any kind of python, and any control flow</p>
<ul>
<li>PyTorch is a primarily an eager mode framework</li>
</ul>
</section>
<section id="graph-mode" class="slide level2">
<h2>Graph Mode</h2>
<ul>
<li>Preferred by backends and framework builders</li>
<li>Easier to optimize with a compiler</li>
<li>Easier to do automated transformations</li>
</ul>
<p>construct a graph with two add nodes and 3 input nodes, then execute the graph</p>
<p>easy to optimize, only graph nodes allowed, no control flow</p>
<p>Main optimization is fusing operations to avoid memory copies</p>
</section>
<section id="how-does-the-compiler-fit" class="slide level2">
<h2>how does the compiler fit</h2>
<p>in Eager mode there is only a library - no compiler</p>
<p>if you have a matmul followed by an activation function, it is up to the developer to notice that the memory traffic is more expensive then the activation and its up to the developer to know there is another pytorch call (2000 different calls) which does the combined operation and it is up to the developer to change the code</p>
<p>if graph mode (compiler writers call this defered or late) the operations get recorded (not executed) and only get executed when we need the result</p>
</section>
<section id="pytorchs-many-attempts-at-graph-modes" class="slide level2 scrollable">
<h2>PyTorch’s Many Attempts at Graph Modes</h2>
<p>torch.jit.trace</p>
<ol type="1">
<li>Record + replay</li>
<li>Unsound</li>
<li>Can give incorrect results because it ignores Python part of program</li>
</ol>
<p>torch. jit.script</p>
<ol type="1">
<li>AOT parses Python into graph format</li>
<li>Only works on ~45% of real world models</li>
<li>High effort to “TorchScript” models</li>
<li>PyTorch Models Are Not Static Graphs</li>
</ol>
<p>PyTorch users write models where program graphs are impossible</p>
<p>Convert tensors to native Python types (x.item(), x.tolist(), int(x), etc)</p>
<p>Use other frameworks (numpy/xarray/etc) for part of their model</p>
<p>Data dependent Python control flow or other dynamism Exceptions, closures, generators, classes, etc</p>
<p>torch xla</p>
<p>defered execution. rather then do the graph operation, just save it and execute as late as possible</p>
<p>very slow, big performance cliffs</p>
</section>
<section id="torch.compilemodel---converts-a-pytorch-eager-program-to-a-graph" class="slide level2">
<h2>torch.compile(model) - converts a pytorch eager program to a graph</h2>
<p>torch.dynamo - which dynamically captures Python code execution and creates a static computational graph.</p>
<p>torch.Inductor- compiler that optimimzes static computation graphs</p>
</section>
<section id="dynamo" class="slide level2">
<h2>dynamo</h2>
<pre><code>import torch
from typing import List

import torch._dynamo
torch._dynamo.config.suppress_errors = True

def my_compiler(gm: torch.fx.GraphModule, example_inputs: List[torch.Tensor]):
    print("my compiler() called with fx graph")
    gm.graph.print_tabular()
    return gm

@torch.compile(backend=my_compiler)
def toy_example(a,b):
    x = a / (torch.abs(a)+1)
    if b.sum() &lt; 0:
        b  = b * -1
    return x *b

for _ in range(100):
    toy_example(torch.randn(10), torch.randn(10))
</code></pre>
</section>
<section id="output" class="slide level2">
<h2>output</h2>
<div class="columns">
<div class="column" style="width:35%;">
<pre><code>def toy_example(a,b):
    x = a / (torch.abs(a)+1)
    if b.sum() &lt; 0:
        b  = b * -1
    return x *b</code></pre>
</div><div class="column" style="width:65%;">
<pre><code>opcode         name    target        args      
------       ------  ---------    -----------
placeholder    l_a_    L_a_         ()         
placeholder    l_b_    L_b_         ()         
call_function  abs_1   &lt;abs&gt;        (l_a_,)   
call_function  add     &lt;add&gt;        (abs_1, 1) 
call_function  x       &lt;truediv&gt;    (l_a_, add)
call_method    sum_1   sum          (l_b_,)   
call_function  lt      &lt;lt&gt;         (sum_1, 0) 
output         output  output       ((x, lt),)
------       ------  ---------    -----------
placeholder    l_b_    L_b_         ()           
placeholder    l_x_    L_x_         ()           
call_function  b       &lt;mul&gt;        (l_b_, -1)   
call_function  mul_1   &lt;mul&gt;        (l_x_, b)    
output         output  output       ((mul_1,),) 
------       ------  ---------    -----------        
placeholder    l_x_    L_x_         ()            
placeholder    l_b_    L_b_         ()            
call_function  mul     &lt;mul&gt;        (l_x_, l_b_)  
output         output  output       ((mul,),)     </code></pre>
</div></div>
</section>
<section id="implementation-1" class="slide level2">
<h2>implementation</h2>
<p>python builds a frameObject (pointer to codeObject + arguments)</p>
<p>passes this to eval</p>
<p>codeObject allows for extra user data and for a user function to be called between the frameObject and eval</p>
<p>This makes it easy to add a custom JIT</p>
<p>split the function into two parts - the python part and the torch part</p>
<p>This is reused if the guards pass</p>
</section>
<section id="pytorch-example-1" class="slide level2">
<h2>pytorch example 1</h2>
<pre><code>def toy_example(a,b):
    x = a / (torch.abs(a)+1)
    if b.sum() &lt; 0:
        b  = b * -1
    return x *b

for _ in range(100):
    toy_example(torch.randn(10), torch.randn(10))</code></pre>
<p>sometimes the sum is negative but not always</p>
</section>
<section id="implementation-2" class="slide level2">
<h2>implementation</h2>

<img data-src="pytorch/s1.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s2.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s3.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s4.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s5.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s6.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s7.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s8.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s9.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s10.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s11.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="pytorch/s12.png" class="r-stretch"></section>
<section id="graph" class="slide level2">
<h2>graph</h2>
<table class="caption-top">
<colgroup>
<col style="width: 15%">
<col style="width: 7%">
<col style="width: 64%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th>opcode</th>
<th>name</th>
<th>target</th>
<th>args</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>placeholder</td>
<td>l_a_</td>
<td>L_a_</td>
<td>()</td>
</tr>
<tr class="even">
<td>placeholder</td>
<td>l_b_</td>
<td>L_b_</td>
<td>()</td>
</tr>
<tr class="odd">
<td>call_function</td>
<td>abs_1</td>
<td>&lt;built-in method abs of type object at 0x728736add8a0&gt;</td>
<td>(l_a_,)</td>
</tr>
<tr class="even">
<td>call_function</td>
<td>add</td>
<td><built-in function="" add=""></built-in></td>
<td>(abs_1, 1)</td>
</tr>
<tr class="odd">
<td>call_function</td>
<td>x</td>
<td><built-in function="" truediv=""></built-in></td>
<td>(l_a_, add)</td>
</tr>
<tr class="even">
<td>call_method</td>
<td>sum_1</td>
<td>sum</td>
<td>(l_b_,)</td>
</tr>
<tr class="odd">
<td>call_function</td>
<td>lt</td>
<td><built-in function="" lt=""></built-in></td>
<td>(sum_1, 0)</td>
</tr>
<tr class="even">
<td>output</td>
<td>output</td>
<td>output</td>
<td>((x, lt),)</td>
</tr>
</tbody>
</table>
</section>
<section id="code" class="slide level2">
<h2>code</h2>
<pre><code>def toy_example(a,b):
   (x,lt) = call1(a,b)
   if lt:
      f1(b,x)
   else:
      f2(b,x)

def f1(b, x):
   b  = b * -1
   return x *b

def f2(b,x):
   return x *b</code></pre>
</section>
<section id="guards" class="slide level2">
<h2>guards:</h2>
<p>check_tensor(L[‘a’], Tensor, torch.float32, size=[10], stride=[1]) check_tensor(L[‘b’], Tensor, torch.float32, size=[10], stride=[1])</p>
<p>walk the byte code again for f1</p>
<pre><code>b  = b * -1
return x *b</code></pre>
</section>
<section id="traced-graph" class="slide level2">
<h2>TRACED GRAPH</h2>
<table class="caption-top">
<thead>
<tr class="header">
<th>pcode n</th>
<th>ame t</th>
<th>arget a</th>
<th>rgs k</th>
<th style="text-align: left;">wargs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>placeholder</td>
<td>l_b_</td>
<td>L_b_</td>
<td>()</td>
<td style="text-align: left;">{}</td>
</tr>
<tr class="even">
<td>placeholder</td>
<td>l_x_</td>
<td>L_x_</td>
<td>()</td>
<td style="text-align: left;">{}</td>
</tr>
<tr class="odd">
<td>call_function</td>
<td>b</td>
<td><built-in function="" mul=""></built-in></td>
<td>(l_b_, -1)</td>
<td style="text-align: left;">{}</td>
</tr>
<tr class="even">
<td>call_function</td>
<td>mul_1</td>
<td><built-in function="" mul=""></built-in></td>
<td>(l_x_, b)</td>
<td style="text-align: left;">{}</td>
</tr>
<tr class="odd">
<td>utput o</td>
<td>utput o</td>
<td>utput (</td>
<td>(mul_1,),) {</td>
<td style="text-align: left;">}</td>
</tr>
</tbody>
</table>
</section>
<section id="other-branch" class="slide level2">
<h2>other branch</h2>
<pre><code>guards: check_tensor(L['b'], torch.float32, size=[10], stride=[1]) 
        check_tensor(L['x'], torch.float32, size=[10], stride=[1]) </code></pre>
<p>TRACED GRAPH</p>
<table class="caption-top">
<thead>
<tr class="header">
<th>pcode n</th>
<th>ame t</th>
<th>arget a</th>
<th>rgs k</th>
<th style="text-align: left;">warg</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>aceholder l_</td>
<td>x_ L_</td>
<td>x_ ()</td>
<td>{}</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td>aceholder l_</td>
<td>b_ L_</td>
<td>b_ ()</td>
<td>{}</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td>ll_function mu</td>
<td>l &lt;b</td>
<td>uilt-in function mul&gt; (l</td>
<td><em>x</em>, l_b_) {}</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td>tput ou</td>
<td>tput ou</td>
<td>tput ((</td>
<td>mul,),) {}</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>check_tensor(L[‘b’], torch.float32, size=[10], stride=[1]) check_tensor(L[‘x’], torch.float32, size=[10], stride=[1]) # return x *b # mp/ipykernel_1179164/26</p>
</section>
<section id="linear-traces" class="slide level2">
<h2>linear traces</h2>
<p>Dynamo removes all control flow, if/else, loops, exceptions</p>
<p>specializes (bakes in) all non-tensor objects (numbers, strings, classes )</p>
<div class="columns">
<div class="column">
<pre><code>
@torch.compile
def fn(f,n):
  y = x ** 2
  if n &gt;= 0:
    return (n +1)* y
  else:
    return x /y 

x = torch.randn(200)
fn(x,2)</code></pre>
</div><div class="column">
<pre><code>def forward(l_x_: torch.Tensor):
   y = l_x_ ** 2
   mul 3*x
   return (mul,)</code></pre>
</div></div>
</section>
<section id="special-cases" class="slide level2">
<h2>special cases</h2>
<p>Trace integers symbolically</p>
<p>by default it specilizes on every integer in the graph but if a subsequent vall the value changes it traces symbolically but 0 or 1 are always speciaized</p>
</section>
<section id="multiple-traces" class="slide level2">
<h2>multiple traces</h2>
<pre><code>import torch
from typing import List

import torch._dynamo
torch._dynamo.config.suppress_errors = True

def my_compiler(gm: torch.fx.GraphModule, example_inputs: List[torch.Tensor]):
    print("my compiler() called with fx graph")
    gm.graph.print_tabular()
    return gm

@torch.compile(backend=my_compiler)
def toy_example(a,b):
    x = a / (torch.abs(a)+1)
    if b.sum() &lt; 0:
        b  = b * -1
    return x *b

for _ in range(100):
    toy_example(torch.randn(10), torch.randn(10))


import torch
from typing import List

import torch._dynamo
torch._dynamo.config.suppress_errors = True

def my_compiler(gm: torch.fx.GraphModule, example_inputs: List[torch.Tensor]):
    print("my compiler() called with fx graph")
    gm.graph.print_tabular()
    return gm</code></pre>
</section>
<section id="implementation-3" class="slide level2">
<h2>implementation</h2>
<p>pep 523, allows python function to see unevaluated frames, function + arguments</p>
<p>normally just calls the function</p>


</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp("https:\/\/normrubin\.github\.io\/");
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>