<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Dynamic Compilers – EECE7398 Fall 2024</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../lectures/14_gpu_compilers.html" rel="next">
<link href="../lectures/12_memory.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


<meta property="og:title" content="Dynamic Compilers – EECE7398 Fall 2024">
<meta property="og:description" content="Homepage EECS7398 - Special Topic: Compilers, Fall 2024.">
<meta property="og:site_name" content="EECE7398 Fall 2024">
</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    <div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="revealjs_13_dynamic_compilers.qmd.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../weekly.html">EECS 7398</a></li><li class="breadcrumb-item"><a href="../lectures/010_compiler_overview.html">Lectures</a></li><li class="breadcrumb-item"><a href="../lectures/13_dynamic_compilers.html">Dynamic Compilers</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Dynamic Compilers</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="jit-just-in-time-compilers-vs-aotahead-of-time-compilers" class="level2">
<h2 class="anchored" data-anchor-id="jit-just-in-time-compilers-vs-aotahead-of-time-compilers">jit (just in time) compilers vs aot(ahead of time) compilers</h2>
<p>a jit compiler translates code into isa while the program executes</p>
<p>pro:</p>
<p>more information</p>
<p>con:</p>
<p>compile time slows down execution</p>
</section>
<section id="some-options" class="level2">
<h2 class="anchored" data-anchor-id="some-options">some options</h2>
<ul>
<li>compile a function the first time it is called</li>
<li>compile a function after it has been called a lot (needs an interpreter) We call these hot functions</li>
<li>build a trace of instructions executed and compile the hot traces (a trace has no branches)</li>
<li>A variation I used: ran the program to completion using a tracing interpreter, recompile off line, future execution is a mix of interpreter and compiled code</li>
</ul>
</section>
<section id="can-jit-compiled-code-run-faster-then-aot-code" class="level2">
<h2 class="anchored" data-anchor-id="can-jit-compiled-code-run-faster-then-aot-code">Can jit compiled code run faster then aot code?</h2>
</section>
<section id="comparison" class="level2">
<h2 class="anchored" data-anchor-id="comparison">Comparison</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>aot</th>
<th>jit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>cannot inline libraries</td>
<td>can inline (even class methods)</td>
</tr>
<tr class="even">
<td>no runtime code gen</td>
<td>can use run time code gen</td>
</tr>
<tr class="odd">
<td>no speculative opts</td>
<td>can use spec opts</td>
</tr>
<tr class="even">
<td>less information</td>
<td>more information</td>
</tr>
<tr class="odd">
<td>overall performance lower</td>
<td>overall performance often higher</td>
</tr>
<tr class="even">
<td>full speed from the start</td>
<td>requires warmup</td>
</tr>
<tr class="odd">
<td>no compile cost at run time</td>
<td>overhead to run compiler</td>
</tr>
</tbody>
</table>
</section>
<section id="tradeoffs" class="level2">
<h2 class="anchored" data-anchor-id="tradeoffs">Tradeoffs</h2>
<ol type="1">
<li>The time to compile is part of the total execution time</li>
<li>might run less optimizations to speed up execution time</li>
<li>might look at run time info</li>
<li>same code might be compiled many times</li>
</ol>
<p>Why would the same code be compiled more than once?</p>
</section>
<section id="tiered-compilers" class="level2">
<h2 class="anchored" data-anchor-id="tiered-compilers">tiered compilers</h2>
<p>Since compilation is costly, do not compile functions that are only called once and do not contain a long running loop</p>
<p>we have a series of compilers, each with more aggressive optimization and each allowed to take longer</p>
<ul>
<li>the lowest tier is the interpreter</li>
<li>the next is the base line compiler</li>
</ul>
<hr>
<ol type="1">
<li>start interpreting the code</li>
<li>if some part of the code takes a long time, compile it with the next higher tier</li>
<li>is some runtime info changes, compile it again</li>
</ol>
</section>
<section id="magic-numbers" class="level2">
<h2 class="anchored" data-anchor-id="magic-numbers">magic numbers</h2>
<p>associate a counter with branches and functions if the counter reaches some magic number use one of the compilers</p>
<p>if the counter for a backward branch, you recompile, but the code is executing in the middle of a loop, how do you insert the newly compiled code?</p>
</section>
<section id="questions-when-building-a-jit" class="level2">
<h2 class="anchored" data-anchor-id="questions-when-building-a-jit">questions when building a JIT</h2>
<ul>
<li>what strategy do you use to invoke the jit</li>
<li>do you have to execute for a while before calling the jit</li>
<li>how much info do you need</li>
<li>what is the price of wrong info</li>
<li>are there easy and hard programs</li>
<li>do the easy programs match up with users common programs</li>
</ul>
</section>
<section id="speculation" class="level2">
<h2 class="anchored" data-anchor-id="speculation">Speculation</h2>
<ul>
<li>assume some property is true, compile using that info this is always a gamble, so you need to recover if the assumption was wrong</li>
<li>assume a variable is an int, and does not overflow</li>
<li>assume properties of an object is fixed</li>
<li>assume the target of call is always the same</li>
<li>assume past behavior predicts future behavior</li>
</ul>
</section>
<section id="flow" class="level2">
<h2 class="anchored" data-anchor-id="flow">flow</h2>
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>graph LR</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>interpreter -- hot? --&gt; profiling </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>profiling -- stats --&gt; optimizing_compiler</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>optimizing_compiler --&gt; compiled_code</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>compiled_code -- deoptimze --&gt; interpreter</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>interpreter -- already_compiled --&gt; compiled_code</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph LR
interpreter -- hot? --&gt; profiling 
profiling -- stats --&gt; optimizing_compiler
optimizing_compiler --&gt; compiled_code
compiled_code -- deoptimze --&gt; interpreter
interpreter -- already_compiled --&gt; compiled_code
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="boxed-values" class="level2">
<h2 class="anchored" data-anchor-id="boxed-values">boxed values</h2>
<p>Many languages do not use strong static typing</p>
<p>for example in python</p>
<p>x = x + 1</p>
<p>x could be an int/float/object/string etc</p>
<p>the value of x needs to carry a type. Represent x as a pair (type, pointer or bits) The pair is called a boxed value</p>
<p>then to generate code for the plus we have to figure out what kind of add, based on the type</p>
</section>
<section id="inline-caches" class="level2">
<h2 class="anchored" data-anchor-id="inline-caches">inline caches</h2>
<p>in languages like python, calls to a method are more expensive then calls to a method in c++ why?</p>
<p>. . .</p>
<p>Python objects are implemented as hash tables. While C++ uses virtual tables</p>
<p>how does that effect the cost?</p>
</section>
<section id="first-c-virtual-tables" class="level2">
<h2 class="anchored" data-anchor-id="first-c-virtual-tables">first C++ virtual tables</h2>
<p>in C++ a method call takes two dereferences</p>
<ol type="1">
<li>first find the v-table</li>
<li>second used a <strong><em>fixed offset</em></strong> from the table start to find the address</li>
</ol>
</section>
<section id="what-do-we-need-to-keep-the-offset-fixed" class="level2">
<h2 class="anchored" data-anchor-id="what-do-we-need-to-keep-the-offset-fixed">What do we need to keep the offset fixed?</h2>
<p>if derived inherits from base, and both have a function f. the offset to f has to be the same.</p>
<p>in languages where objects are hash tables, the c++ dereference becomes a hash table lookup, which is slower</p>
</section>
<section id="tradeoffs-1" class="level2">
<h2 class="anchored" data-anchor-id="tradeoffs-1">tradeoffs</h2>
<p>In a dynamically typed language like python we can add or remove methods easily</p>
<p>but method calls are expensive</p>
<p>we want to make these calls cheaper</p>
</section>
<section id="inline-caches-at-each-call-site" class="level2">
<h2 class="anchored" data-anchor-id="inline-caches-at-each-call-site">inline caches at each call site</h2>
<p>the first time we call a method, we know the type (because we are generating code at runtime)</p>
<div class="columns">
<div class="column">
<pre><code>def func(a,b,c):
  for i in range(10):
     foo(a,b,c)</code></pre>
</div><div class="column">
<pre><code>def func(a,b,c):
  for i in range(10):
    if isinstance(a, type1)
      body of foo  
    else:
      other = lookup 'foo' in the hash
      call other(a,b,c
      )</code></pre>
</div>
</div>
</section>
<section id="inline-caches-at-the-function-site" class="level2">
<h2 class="anchored" data-anchor-id="inline-caches-at-the-function-site">inline caches at the function site</h2>
<div class="columns">
<div class="column" style="width:30%;">
<pre><code>def func(a,b,c):
  for i in range(10):
     _foo(a,b,c</code></pre>
</div><div class="column">
<pre><code>def _foo(a,b,c)
  if isinstance(a, type1)
      body of foo  
    else:
      other = lookup 'foo' in a
      call other(a,b,c)</code></pre>
</div>
</div>
<p>is it better to do this at the call site or at the function site?</p>
</section>
<section id="polymorphic-calls" class="level2">
<h2 class="anchored" data-anchor-id="polymorphic-calls">polymorphic calls</h2>
<p>if the type changes at runtime (the call to other is taken) does the optimization help?</p>
<p>could invalidate the table and rebuild it with another case</p>
</section>
<section id="what-are-the-costs" class="level2">
<h2 class="anchored" data-anchor-id="what-are-the-costs">what are the costs</h2>
<p>for example v8 compiler</p>
<p>monomorphic inline hit - 10 instructions</p>
<p>polymorphic hit - 35 instructions for 10 types, 60 instructions for 20 types</p>
<p>cache miss 1000-4000 instructions</p>
</section>
<section id="value-specialization" class="level2">
<h2 class="anchored" data-anchor-id="value-specialization">value specialization</h2>
<p>Oddly many functions are called with the same arguments</p>
</section>
<section id="an-example" class="level2">
<h2 class="anchored" data-anchor-id="an-example">an example</h2>
<p>given a vector v of size n, and a parameter q find the element of v that is closest to q</p>
<pre><code> function closest(v, q, n) {
    if (n == 0) {
          throw "Error";
    } else {
        var i = 0;
        var d = 0ffffffff;
        while (i &lt; n) {
           var nd = abs(v[i] - q);
           if (nd &lt;= d) d = nd; 
           i++;
        }    
        return d;  
      } 
}</code></pre>
</section>
<section id="the-cfg" class="level2">
<h2 class="anchored" data-anchor-id="the-cfg">the cfg</h2>
<p>we want to recompile this for specific v,q, and n, where we restart at the while test</p>
<hr>
<div class="columns">
<div class="column" style="width:40%;">
<pre><code> function closest(v, q, n) {
    if (n == 0) {
          throw "Error";
    } else {
      var i = 0;
      var d = 0ffffffff;
      while (i &lt; n) {
         var nd = abs(v[i] - q);
         if (nd &lt;= d) d = nd; 
         i++;
        }    
        return d;  
      } 
}</code></pre>
</div><div class="column" style="width:40%;">
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>normal_entry["function entry</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>              v = param[0]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>              q = param[1]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>              n = param[2]</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>              if (n ==0) goto l1"]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>l1["l1: throw error"]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>l2[" l2: i0 = 0</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>     d = 0fffffff"]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>normal_entry --&gt; l1</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>normal_entry--&gt; l2</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>l3["l3: i1 = phi(i0, i2, i3)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    d1 = phi(d0, d3, d4)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>l2--&gt; l3</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep["start replace</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>                   v = param[0]</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>                  q = param[1]</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>                  n = param[2]</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>                  i3 = stack[0]</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>                  d4 = stack[1]"]</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>l5["l5: t0 = 4* i</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>     t1 = v[t0]</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>l3 --&gt; l5 </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>l3--&gt; l4</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>l4["l4: return d1"]</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>l5--&gt; l7</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>   i2 = i1 + 1</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>   goto l3"]</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>l7--&gt; l9</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>l6--&gt; l9</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>l8["l8: throw boundsError"]</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>l5 --&gt; l8</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
normal_entry["function entry
              v = param[0]
              q = param[1]
              n = param[2]
              if (n ==0) goto l1"]

l1["l1: throw error"]
l2[" l2: i0 = 0
     d = 0fffffff"]
normal_entry --&gt; l1
normal_entry--&gt; l2
l3["l3: i1 = phi(i0, i2, i3)
    d1 = phi(d0, d3, d4)
    if (i1 &lt; n) go to l5"  ]
l2--&gt; l3
entry_on_stack_rep["start replace
                   v = param[0]
                  q = param[1]
                  n = param[2]
                  i3 = stack[0]
                  d4 = stack[1]"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="two-entries" class="level2">
<h2 class="anchored" data-anchor-id="two-entries">two entries</h2>
<p>First entry is the regular starting point, second is the entry if we are currently running the loop in the interpreter</p>
<p>Since we are compiling the function while in the loop we can ask the interpreter for values</p>
<ul>
<li>v == load[0]</li>
<li>q = 42</li>
<li>n = 100</li>
<li>i = 40</li>
<li>d = 0fffffff</li>
</ul>
<hr>
<div class="columns">
<div class="column" style="width:30%;">
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>normal_entry["function entry</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>              v = param[0]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>              q = param[1]</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>              n = param[2]</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>              if (n ==0) goto l1"]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>l1["l1: throw error"]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>l2[" l2: i0 = 0</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>     d = 0fffffff"]</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>normal_entry --&gt; l1</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>normal_entry--&gt; l2</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>l3["l3: i1 = phi(i0, i2, i3)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    d1 = phi(d0, d3, d4)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>l2--&gt; l3</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep["start replace</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>                   v = param[0]</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>                  q = param[1]</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>                  n = param[2]</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>                  i3 = stack[0]</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                  d4 = stack[1]"]</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>l5["l5: t0 = 4* i</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>     t1 = v[t0]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>l3 --&gt; l5 </span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>l3--&gt; l4</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>l4["l4: return d1"]</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>l5--&gt; l7</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>   i2 = i1 + 1</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>   goto l3"]</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>l7--&gt; l9</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>l6--&gt; l9</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>l8["l8: throw boundsError"]</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>l5 --&gt; l8</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
normal_entry["function entry
              v = param[0]
              q = param[1]
              n = param[2]
              if (n ==0) goto l1"]

l1["l1: throw error"]
l2[" l2: i0 = 0
     d = 0fffffff"]
normal_entry --&gt; l1
normal_entry--&gt; l2
l3["l3: i1 = phi(i0, i2, i3)
    d1 = phi(d0, d3, d4)
    if (i1 &lt; n) go to l5"  ]
l2--&gt; l3
entry_on_stack_rep["start replace
                   v = param[0]
                  q = param[1]
                  n = param[2]
                  i3 = stack[0]
                  d4 = stack[1]"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div><div class="column" style="width:40%;">
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>normal_entry["function entry</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>              v = load[0]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>              q = q = 42 </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>              n = 100</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>              if (n ==0) goto l1"]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>l1["l1: throw error"]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>l2[" l2: i0 = 0</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>     d = 0fffffff"]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>normal_entry --&gt; l1</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>normal_entry--&gt; l2</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>l3["l3: i1 = phi(i2, i3)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    d1 = phi(d3, d4)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>l2--&gt; l3</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep["start replace</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                   v = load [0]</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>                  q = 42</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>                  n = 100</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>                  i3 = 40</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>                  d4 = offfffff"]</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>l5["l5: t0 = 4* i</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>     t1 = v[t0]</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>l3 --&gt; l5 </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>l3--&gt; l4</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>l4["l4: return d1"]</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>l5--&gt; l7</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>   i2 = i1 + 1</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>   goto l3"]</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>l7--&gt; l9</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>l6--&gt; l9</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>l8["l8: throw boundsError"]</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>l5 --&gt; l8</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
normal_entry["function entry
              v = load[0]
              q = q = 42 
              n = 100
              if (n ==0) goto l1"]

l1["l1: throw error"]
l2[" l2: i0 = 0
     d = 0fffffff"]
normal_entry --&gt; l1
normal_entry--&gt; l2
l3["l3: i1 = phi(i2, i3)
    d1 = phi(d3, d4)
    if (i1 &lt; n) go to l5"  ]
l2--&gt; l3
entry_on_stack_rep["start replace
                   v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="dead-code-elimination" class="level2">
<h2 class="anchored" data-anchor-id="dead-code-elimination">dead code elimination</h2>
<p>After this all calls to the function assume these arguments so no need to keep the regular entry</p>
<div class="columns">
<div class="column" style="width:30%;">
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>normal_entry["function entry</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>              v = load[0]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>              q = q = 42 </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>              n = 100</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>              if (n ==0) goto l1"]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>l1["l1: throw error"]</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>l2[" l2: i0 = 0</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>     d = 0fffffff"]</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>normal_entry --&gt; l1</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>normal_entry--&gt; l2</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>l3["l3: i1 = phi(i2, i3)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    d1 = phi(d3, d4)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>l2--&gt; l3</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep["start replace</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                   v = load [0]</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                  q = 42</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                  n = 100</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                  i3 = 40</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                  d4 = offfffff"]</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>l5["l5: t0 = 4* i</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>     t1 = v[t0]</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>l3 --&gt; l5 </span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>l3--&gt; l4</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>l4["l4: return d1"]</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>l5--&gt; l7</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>   i2 = i1 + 1</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>   goto l3"]</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>l7--&gt; l9</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>l6--&gt; l9</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>l8["l8: throw boundsError"]</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>l5 --&gt; l8</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
normal_entry["function entry
              v = load[0]
              q = q = 42 
              n = 100
              if (n ==0) goto l1"]

l1["l1: throw error"]
l2[" l2: i0 = 0
     d = 0fffffff"]
normal_entry --&gt; l1
normal_entry--&gt; l2
l3["l3: i1 = phi(i2, i3)
    d1 = phi(d3, d4)
    if (i1 &lt; n) go to l5"  ]
l2--&gt; l3
entry_on_stack_rep["start replace
                   v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div><div class="column" style="width:45%;">
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>l3["l3: i1 = phi(i2, i3)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    d1 = phi(dd3, d4)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep["start replace</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                   v = load [0]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                  q = 42</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                  n = 100</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                  i3 = 40</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                  d4 = offfffff"]</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>l5["l5: t0 = 4* i</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>     t1 = v[t0]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>l3 --&gt; l5 </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>l3--&gt; l4</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>l4["l4: return d1"]</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>l5--&gt; l7</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>   i2 = i1 + 1</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>   goto l3"]</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>l7--&gt; l9</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>l6--&gt; l9</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>l8["l8: throw boundsError"]</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>l5 --&gt; l8</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD

l3["l3: i1 = phi(i2, i3)
    d1 = phi(dd3, d4)
    if (i1 &lt; n) go to l5"  ]
entry_on_stack_rep["start replace
                   v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="array-in-bounds-check" class="level2">
<h2 class="anchored" data-anchor-id="array-in-bounds-check">array in bounds check</h2>
<p>we can pattern match loops with bounds checks if we know the limit</p>
<hr>
<div class="columns">
<div class="column" style="width:30%;">
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>l3["l3: i1 = phi(i2, i3)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    d1 = phi(dd3, d4)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep["start replace</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                   v = load [0]</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                  q = 42</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                  n = 100</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                  i3 = 40</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>                  d4 = offfffff"]</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>l5["l5: t0 = 4* i</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>     t1 = v[t0]</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>     notinbounds(t1, n) go to l8"]</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>l3 --&gt; l5 </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>l3--&gt; l4</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>l4["l4: return d1"]</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>l5--&gt; l7</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>   i2 = i1 + 1</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>   goto l3"]</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>l7--&gt; l9</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>l6--&gt; l9</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>l8["l8: throw boundsError"]</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>l5 --&gt; l8</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD

l3["l3: i1 = phi(i2, i3)
    d1 = phi(dd3, d4)
    if (i1 &lt; n) go to l5"  ]
entry_on_stack_rep["start replace
                   v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     notinbounds(t1, n) go to l8"]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l8["l8: throw boundsError"]
l5 --&gt; l8
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div><div class="column" style="width:45;">
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>l3["l3: i1 = phi(i0, i2, i3)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    d1 = phi(d0, d3, d4)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    if (i1 &lt; n) go to l5"  ]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep["start replace</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                   v = load [0]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                  q = 42</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                  n = 100</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                  i3 = 40</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>                  d4 = offfffff"]</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>l5["l5: t0 = 4* i</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>     t1 = v[t0]</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>     "]</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>l3 --&gt; l5 </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>l3--&gt; l4</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>l4["l4: return d1"]</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>l5--&gt; l7</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>l7[" l7: nd = abs(t1, q)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>   i2 = i1 + 1</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>   goto l3"]</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>l7--&gt; l9</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>l6--&gt; l9</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>l9--&gt; l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD

l3["l3: i1 = phi(i0, i2, i3)
    d1 = phi(d0, d3, d4)
    if (i1 &lt; n) go to l5"  ]
entry_on_stack_rep["start replace
                   v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l5["l5: t0 = 4* i
     t1 = v[t0]
     "]

l3 --&gt; l5 
l3--&gt; l4
l4["l4: return d1"]
l5--&gt; l7
l7[" l7: nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   goto l3"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l9--&gt; l3
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="loop-inversion" class="level2">
<h2 class="anchored" data-anchor-id="loop-inversion">loop inversion</h2>
<p>a general while loop, loop might never run so cannot move code out of the loop</p>
<pre><code>while(cond){
  ...
}</code></pre>
<p>can be changed into</p>
<pre><code>if (cond){
  do {
    ...
  } while(cond)
}</code></pre>
<p>for this loop the first time around i = 40, n = 100 so the first condition is true</p>
</section>
<section id="after-loop-inversion" class="level2">
<h2 class="anchored" data-anchor-id="after-loop-inversion">after loop inversion</h2>
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>l3["l3: i1 = phi(i2, i3)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    d1 = phi(d3, d4)" ]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep["v = load [0]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                  q = 42</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                  n = 100</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                  i3 = 40</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                  d4 = offfffff"]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>entry_on_stack_rep --&gt; l3</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>l3 --&gt; l7</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>l4["l4: return d1"]</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>l7[" l7: l5: t0 = 4* i</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>t1 = v[t0]</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>nd = abs(t1, q)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>   if (nd &gt; d1) go to l9"]</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>l9["l9: d3 = phi(d1, d2)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>   i2 = i1 + 1</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>   if (i2 &gt; n) goto l4"]</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>l7--&gt; l9</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>l7--&gt; l6["l6: d2 = nd"]</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>l6--&gt; l9</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>l9--&gt; l3</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>l9--&gt; l4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
l3["l3: i1 = phi(i2, i3)
    d1 = phi(d3, d4)" ]
entry_on_stack_rep["v = load [0]
                  q = 42
                  n = 100
                  i3 = 40
                  d4 = offfffff"]
entry_on_stack_rep --&gt; l3
l3 --&gt; l7


l4["l4: return d1"]
l7[" l7: l5: t0 = 4* i
t1 = v[t0]
nd = abs(t1, q)
   if (nd &gt; d1) go to l9"]

l9["l9: d3 = phi(d1, d2)
   i2 = i1 + 1
   if (i2 &gt; n) goto l4"]
l7--&gt; l9
l7--&gt; l6["l6: d2 = nd"]
l6--&gt; l9
l9--&gt; l3
l9--&gt; l4
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">results</h2>
<p>specialized code is shorter and compiles faster</p>
<p>since we know that the loop goes from 42 to 100, we could unroll the loop</p>
</section>
<section id="dynamic-compilation-and-pgo-profile-guided-optimization" class="level2">
<h2 class="anchored" data-anchor-id="dynamic-compilation-and-pgo-profile-guided-optimization">dynamic compilation and pgo (profile guided optimization)</h2>
<p>workload dependent – dynamically you only measure what you actually see – that can lead to sub-optimal choices if you make them “forever”</p>
<p>If your program has phases, where it does some kind of behavior for a while, and then shifts to another behavior afterwards, then that workload that you originally measured isn’t representative anymore!</p>
<p>When you do PGO you’re supposed to do it on the entire program and it’s supposed to be representative, whereas when you’re tracing you’re doing that live!</p>
</section>
<section id="confidence-vs-time" class="level2">
<h2 class="anchored" data-anchor-id="confidence-vs-time">confidence vs time</h2>
<p>set the magic numbers high- run a long time slowly, but gather more info</p>
<p>set the magic number low, quickly recompile based on less info</p>
</section>
<section id="dynamic-compilers-part-2" class="level1">
<h1>Dynamic Compilers part 2</h1>
<section id="c-method-call" class="level2">
<h2 class="anchored" data-anchor-id="c-method-call">C++ method call</h2>
<p>each object has a pointer to a vtable, which is a table of function pointers to all the virtual functions</p>
<p>each derived object has its own vtable, which has the same offsets for all the common virtual functions</p>
<p>to find the code takes two dereferences</p>
<ol type="1">
<li>find the vtable (one per class) (one load)</li>
<li>at a fixed offset (determined by the virtual function name) find the code (second load)</li>
</ol>
</section>
<section id="a-python-example" class="level2">
<h2 class="anchored" data-anchor-id="a-python-example">a python example</h2>
<p>more flexible</p>
<ol type="1">
<li>find the hash table (one per instance)</li>
<li>lookup the virtual function in the hash table</li>
</ol>
<pre><code>
class Thing:
    def __init__(self, kind):
        self.kind = kind 

thing = Thing('car')

def honk(self):
    print(f"{self.kind} says Honk")

thing.honk = honk.__get__(thing)  ## add a method dynamically to one instance 

thing.honk()  ## call it 
</code></pre>
<p>honk.__get__(thing) returns a bound method, when this method is called thing is passed as first argument</p>
</section>
<section id="dynamic-chunks" class="level2">
<h2 class="anchored" data-anchor-id="dynamic-chunks">dynamic chunks</h2>
<p>So far:</p>
<ol type="1">
<li>run interpreter or tier 0 compiler</li>
<li>collect statistics on call counts or branch counts</li>
<li>when count is high enough recompile the hot functions</li>
<li>specialize the hot functions based on common values</li>
</ol>
</section>
<section id="the-unit-of-compilation-is-the-static-function" class="level2">
<h2 class="anchored" data-anchor-id="the-unit-of-compilation-is-the-static-function">The unit of compilation is the static function</h2>
<p>an alterative is called <strong><em>trace compilation</em></strong></p>
<ol type="1">
<li>run interpreter or tier 0 compiler</li>
<li>collect the statements executed (no not collect control flow)</li>
<li>this produces a linear trace of instructions</li>
<li>recompile the trace using optimizations like value numbering</li>
<li>if the next time the code executes, it takes a different path, fix things up</li>
</ol>
</section>
<section id="trace-compilation-0" class="level2">
<h2 class="anchored" data-anchor-id="trace-compilation-0">trace compilation 0</h2>
<p>In a linear trace the number of assumptions you’re making accumulates as you execute [towards the end of the trace you have the most assumptions built up]</p>
<p>If you have an always-taken control flow, e.g.&nbsp;some virtual function call that’s always calling the same actual function, a tracing compiler will treat all back-to-back branches as one set of straight line code</p>
<p>execute this all back to back, and, whenever convenient, check whether any of those assumptions were wrong”</p>
</section>
<section id="cold-path" class="level2">
<h2 class="anchored" data-anchor-id="cold-path">cold path</h2>
<p>On the “cold path” – again, when it’s convenient undo all the inapplicable things if it turns out the branches weren’t true</p>
<p>Called a “bailout” [“bailing out” of the trace]</p>
<p>At a bailout there is new information. something you didn’t observe when you were tracing</p>
<p>You trust that everything you’ve trace is going to happen, it’s all going to well, and you’re going to be able to optimize for it</p>
<p>But then at runtime, when convenient, you’re going to check, and then bail if you were wrong, and have the rollback on the cold path</p>
<p>So the hot path, the one you’re pretty sure is going to execute, is quite optimal</p>
</section>
<section id="trace-compilation-2" class="level2">
<h2 class="anchored" data-anchor-id="trace-compilation-2">trace compilation 2</h2>
<p>tracing jit: extract a hot path (not a function)</p>
<p>Hot paths are compiled as a single basic block, but the path might go through a call</p>
<p>gamble: next execution starting at this point, go the same way, no branches leave the path</p>
<p>generate machine code for hot paths interpret the rest of the program</p>
<p>unlike specialization, tracing assumes the same path but not the same values</p>
</section>
<section id="an-example-x-42" class="level2">
<h2 class="anchored" data-anchor-id="an-example-x-42">an example (x = 42)</h2>
<div class="columns">
<div class="column">
<pre><code>function main(x){
   y = x +1 
   if x &lt;100 {
      z = f(y)
   } else {
      z = g(y)
   }
   return z
}

function f(a){
   return a -1 
}</code></pre>
</div><div class="column">
<div class="incremental">
<ul class="incremental">
<li>y = x +1</li>
<li>guard(x &lt; 100)</li>
<li>a = y</li>
<li>z = a - 1</li>
<li>return z</li>
</ul>
</div>
</div>
</div>
<p>guards at divergence, guards never return</p>
<p>optimize assuming guards are true, ok to be slow if guard is false</p>
</section>
<section id="move-guards-up" class="level2">
<h2 class="anchored" data-anchor-id="move-guards-up">move guards up</h2>
<p>why is this a good idea?</p>
<p>. . .</p>
<ul>
<li>fail fast</li>
<li>longer region to optimize</li>
</ul>
</section>
<section id="use-local-value-numbering" class="level2">
<h2 class="anchored" data-anchor-id="use-local-value-numbering">use local value numbering</h2>
<div class="columns">
<div class="column">
<ul>
<li>guard(x &lt; 100)</li>
<li>y = x + 1</li>
<li>a = y</li>
<li>z = a - 1</li>
<li>return z</li>
</ul>
</div><div class="column">
<ul>
<li>guard(x &lt; 100)</li>
<li>return x</li>
</ul>
</div>
</div>
</section>
<section id="how-do-this-in-bril" class="level2">
<h2 class="anchored" data-anchor-id="how-do-this-in-bril">how do this in Bril?</h2>
<p>3 new operations (sort of like out-of-order instructions)</p>
<ol type="1">
<li>speculate - Enter a speculative execution context. No arguments.</li>
<li>commit - End the current speculative context, committing the current speculative state as the “real” state. No arguments.</li>
<li>guard - Check a condition and possibly abort the current speculative context. One argument, the Boolean condition, and one label, to which control is transferred on abort.</li>
</ol>
</section>
<section id="speculate-extension" class="level2">
<h2 class="anchored" data-anchor-id="speculate-extension">speculate extension</h2>
<p><a href="https://github.com/sampsyo/bril/blob/main/docs/lang/spec.md">speculative execution extension</a></p>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">example</h2>
<p>b: bool = const false;</p>
<p>v: int = const 4; v == 4<br>
speculate; v: int = const 2; v == 2 (speculate state) guard b .failed; v == 2 (speculate state) commit;</p>
<p>.failed: print v; v == 4</p>
</section>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">implementation</h2>
<p>you can add a tracer to an interpreter</p>
<p>In a lot of language environments you’ll have an interpreter that’s executing “op at a time”</p>
<p>hook in a tracer which observes what the interpreter is doing and “make some machine code on the side” based on how the interpreter ran</p>
<p>you can implement just a subset of the operations [ed: you might call this property “compiler completeness” for your op set</p>
</section>
<section id="common-bytecode-operations" class="level2">
<h2 class="anchored" data-anchor-id="common-bytecode-operations">common bytecode operations</h2>
<p>implement only the common ones and simply end the trace when you hit one that was not implemented, because it was uncommon</p>
<p>You can build up this trace JIT-ing capability over time, because the system is built with this assumption you can bail out of the trace for whatever reason and go back to thr interpreter</p>
</section>
<section id="an-example-1" class="level2">
<h2 class="anchored" data-anchor-id="an-example-1">an example</h2>
<p>Could imagine making a JIT that just: Covered MULs and ADDs and could make fused/composite MUL/ADD bytecode combinations</p>
<p>Specialize that for one common type; e.g.&nbsp;if you have many types in your language, could support that just for integer types, or just for FP ops e.g.&nbsp;if it were numerical code, and then just bail if any other types showed up at runtime;</p>
<p>trace invariants: suppose traces call to other traces;</p>
<p>trace1 set of ops A, trace2 with set of ops B and we see a transfer from A to B</p>
<p>make sure that the assumptions between those two things are lining up – called <strong><em>trace fusion</em></strong></p>
<p>know the invariants (i.e.&nbsp;“what must be true”) on the exit from A and the entry to B are lining up / compatible with each other</p>
</section>
<section id="method-inlining" class="level2">
<h2 class="anchored" data-anchor-id="method-inlining">method inlining</h2>
<p>In trace compiler you just execute through methods</p>
<p>Inlining kind of the natural path of compilation when doing trace compilation – just linear execution where the jumps/calls/returns simply disappear</p>
</section>
<section id="tail-duplication" class="level2">
<h2 class="anchored" data-anchor-id="tail-duplication">tail duplication</h2>
<p>it is common that multiple traces have a common tail</p>
<pre><code>for() {
  if op_Eq{
     op1 
   } else {
      op2
   }
}
op_t
op_a
op_i
op_l</code></pre>
<pre><code>trace0:  op_eq quard\true  op1 op_t op_a op_i op_l 

trace1:              \false op2 op_t op_a op_i op_l </code></pre>
<p>two traces with the same ending, could generate</p>
<p>one copy of the tail- with arguments showing the header</p>
<p>two copies of the tail- frozen header</p>
</section>
<section id="adding-traces-to-bril" class="level2">
<h2 class="anchored" data-anchor-id="adding-traces-to-bril">adding traces to bril</h2>
<p>How to modify the reference interpreter (warning typescript!)</p>
<p><a href="https://github.com/sampsyo/bril/blob/main/brili.ts">brili</a></p>
<p>there are two functions to consider</p>
<ol type="1">
<li>evalFunc interprets a function by calling evalInstr on each instruction</li>
<li>evalInstr interprets one instruction, large case statement for each instruction</li>
</ol>
</section>
<section id="print-instructions-as-they-execute" class="level2">
<h2 class="anchored" data-anchor-id="print-instructions-as-they-execute">print instructions as they execute</h2>
<ol type="1">
<li>figure out when to start and when to stop</li>
<li>how to print instructions (modify evalInstr by printing instructions) console.log(instr)</li>
</ol>
<p>you have to optimize the trace and put it back</p>
</section>
<section id="traces-and-users" class="level2">
<h2 class="anchored" data-anchor-id="traces-and-users">traces and users</h2>
<p>when a trace works well- it looks amazing - it finds the inner loop and optimizes even through libraries</p>
<p>but users find in hard to understand what the compiler did,</p>
<p>a tiny source change can make a big trace change</p>
<p>hard to fit in a debugger</p>
<p>security is a problem</p>
</section>
<section id="pytorch-2.0" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-2.0">pytorch 2.0</h2>
<p>ml frameworks have two modes</p>
</section>
<section id="eager-mode" class="level2">
<h2 class="anchored" data-anchor-id="eager-mode">Eager Mode</h2>
<ul>
<li>Preferred by users</li>
<li>Easier to use programming model</li>
<li>Easy to debug</li>
</ul>
<p>a + b + c executes two calls to torch.add (if they are tensors)</p>
<p>no place to optimize, allows any kind of python, and any control flow</p>
<ul>
<li>PyTorch is a primarily an eager mode framework</li>
</ul>
</section>
<section id="graph-mode" class="level2">
<h2 class="anchored" data-anchor-id="graph-mode">Graph Mode</h2>
<ul>
<li>Preferred by backends and framework builders</li>
<li>Easier to optimize with a compiler</li>
<li>Easier to do automated transformations</li>
</ul>
<p>construct a graph with two add nodes and 3 input nodes, then execute the graph</p>
<p>easy to optimize, only graph nodes allowed, no control flow</p>
<p>Main optimization is fusing operations to avoid memory copies</p>
</section>
<section id="how-does-the-compiler-fit" class="level2">
<h2 class="anchored" data-anchor-id="how-does-the-compiler-fit">how does the compiler fit</h2>
<p>in Eager mode there is only a library - no compiler</p>
<p>if you have a matmul followed by an activation function, it is up to the developer to notice that the memory traffic is more expensive then the activation and its up to the developer to know there is another pytorch call (2000 different calls) which does the combined operation and it is up to the developer to change the code</p>
<p>if graph mode (compiler writers call this defered or late) the operations get recorded (not executed) and only get executed when we need the result</p>
</section>
<section id="pytorchs-many-attempts-at-graph-modes" class="level2">
<h2 class="anchored" data-anchor-id="pytorchs-many-attempts-at-graph-modes">PyTorch’s Many Attempts at Graph Modes</h2>
<p>torch.jit.trace</p>
<ol type="1">
<li>Record + replay</li>
<li>Unsound</li>
<li>Can give incorrect results because it ignores Python part of program</li>
</ol>
<p>torch. jit.script</p>
<ol type="1">
<li>AOT parses Python into graph format</li>
<li>Only works on ~45% of real world models</li>
<li>High effort to “TorchScript” models</li>
<li>PyTorch Models Are Not Static Graphs</li>
</ol>
<p>PyTorch users write models where program graphs are impossible</p>
<p>Convert tensors to native Python types (x.item(), x.tolist(), int(x), etc)</p>
<p>Use other frameworks (numpy/xarray/etc) for part of their model</p>
<p>Data dependent Python control flow or other dynamism Exceptions, closures, generators, classes, etc</p>
<p>torch xla</p>
<p>defered execution. rather then do the graph operation, just save it and execute as late as possible</p>
<p>very slow, big performance cliffs</p>
</section>
<section id="torch.compilemodel---converts-a-pytorch-eager-program-to-a-graph" class="level2">
<h2 class="anchored" data-anchor-id="torch.compilemodel---converts-a-pytorch-eager-program-to-a-graph">torch.compile(model) - converts a pytorch eager program to a graph</h2>
<p>torch.dynamo - which dynamically captures Python code execution and creates a static computational graph.</p>
<p>torch.Inductor- compiler that optimimzes static computation graphs</p>
</section>
<section id="dynamo" class="level2">
<h2 class="anchored" data-anchor-id="dynamo">dynamo</h2>
<pre><code>import torch
from typing import List

import torch._dynamo
torch._dynamo.config.suppress_errors = True

def my_compiler(gm: torch.fx.GraphModule, example_inputs: List[torch.Tensor]):
    print("my compiler() called with fx graph")
    gm.graph.print_tabular()
    return gm

@torch.compile(backend=my_compiler)
def toy_example(a,b):
    x = a / (torch.abs(a)+1)
    if b.sum() &lt; 0:
        b  = b * -1
    return x *b

for _ in range(100):
    toy_example(torch.randn(10), torch.randn(10))
</code></pre>
</section>
<section id="output" class="level2">
<h2 class="anchored" data-anchor-id="output">output</h2>
<div class="columns">
<div class="column" style="width:35%;">
<pre><code>def toy_example(a,b):
    x = a / (torch.abs(a)+1)
    if b.sum() &lt; 0:
        b  = b * -1
    return x *b</code></pre>
</div><div class="column" style="width:65%;">
<pre><code>opcode         name    target        args      
------       ------  ---------    -----------
placeholder    l_a_    L_a_         ()         
placeholder    l_b_    L_b_         ()         
call_function  abs_1   &lt;abs&gt;        (l_a_,)   
call_function  add     &lt;add&gt;        (abs_1, 1) 
call_function  x       &lt;truediv&gt;    (l_a_, add)
call_method    sum_1   sum          (l_b_,)   
call_function  lt      &lt;lt&gt;         (sum_1, 0) 
output         output  output       ((x, lt),)
------       ------  ---------    -----------
placeholder    l_b_    L_b_         ()           
placeholder    l_x_    L_x_         ()           
call_function  b       &lt;mul&gt;        (l_b_, -1)   
call_function  mul_1   &lt;mul&gt;        (l_x_, b)    
output         output  output       ((mul_1,),) 
------       ------  ---------    -----------        
placeholder    l_x_    L_x_         ()            
placeholder    l_b_    L_b_         ()            
call_function  mul     &lt;mul&gt;        (l_x_, l_b_)  
output         output  output       ((mul,),)     </code></pre>
</div>
</div>
</section>
<section id="implementation-1" class="level2">
<h2 class="anchored" data-anchor-id="implementation-1">implementation</h2>
<p>python builds a frameObject (pointer to codeObject + arguments)</p>
<p>passes this to eval</p>
<p>codeObject allows for extra user data and for a user function to be called between the frameObject and eval</p>
<p>This makes it easy to add a custom JIT</p>
<p>split the function into two parts - the python part and the torch part</p>
<p>This is reused if the guards pass</p>
</section>
<section id="pytorch-example-1" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-example-1">pytorch example 1</h2>
<pre><code>def toy_example(a,b):
    x = a / (torch.abs(a)+1)
    if b.sum() &lt; 0:
        b  = b * -1
    return x *b

for _ in range(100):
    toy_example(torch.randn(10), torch.randn(10))</code></pre>
<p>sometimes the sum is negative but not always</p>
</section>
<section id="implementation-2" class="level2">
<h2 class="anchored" data-anchor-id="implementation-2">implementation</h2>
<p><img src="pytorch/s1.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s2.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s3.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s4.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s5.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s6.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s7.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s8.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s9.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s10.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s11.png" class="img-fluid"></p>
<hr>
<p><img src="pytorch/s12.png" class="img-fluid"></p>
<hr>
<p>graph</p>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 7%">
<col style="width: 64%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th>opcode</th>
<th>name</th>
<th>target</th>
<th>args</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>placeholder</td>
<td>l_a_</td>
<td>L_a_</td>
<td>()</td>
</tr>
<tr class="even">
<td>placeholder</td>
<td>l_b_</td>
<td>L_b_</td>
<td>()</td>
</tr>
<tr class="odd">
<td>call_function</td>
<td>abs_1</td>
<td>&lt;built-in method abs of type object at 0x728736add8a0&gt;</td>
<td>(l_a_,)</td>
</tr>
<tr class="even">
<td>call_function</td>
<td>add</td>
<td><built-in function="" add=""></built-in></td>
<td>(abs_1, 1)</td>
</tr>
<tr class="odd">
<td>call_function</td>
<td>x</td>
<td><built-in function="" truediv=""></built-in></td>
<td>(l_a_, add)</td>
</tr>
<tr class="even">
<td>call_method</td>
<td>sum_1</td>
<td>sum</td>
<td>(l_b_,)</td>
</tr>
<tr class="odd">
<td>call_function</td>
<td>lt</td>
<td><built-in function="" lt=""></built-in></td>
<td>(sum_1, 0)</td>
</tr>
<tr class="even">
<td>output</td>
<td>output</td>
<td>output</td>
<td>((x, lt),)</td>
</tr>
</tbody>
</table>
<p>def toy_example(a,b): (x,lt) = call1(a,b) if lt: f1(b,x) else: f2(b,x)</p>
<p>def f1(b, x): b = b * -1 return x *b</p>
<p>def f2(b,x): return x *b</p>
<pre><code>
guards: 

check_tensor(L['a'], Tensor, torch.float32, size=[10], stride=[1])
check_tensor(L['b'], Tensor, torch.float32, size=[10], stride=[1])

walk the byte code again for f1

b  = b * -1
return x *b

TRACED GRAPH
opcode         name    target                   args         kwargs
 -------------  ------  -----------------------  -----------  --------
 placeholder    l_b_    L_b_                     ()           {}
 placeholder    l_x_    L_x_                     ()           {}
 call_function  b       &lt;built-in function mul&gt;  (l_b_, -1)   {}
 call_function  mul_1   &lt;built-in function mul&gt;  (l_x_, b)    {}
output         output  output                   ((mul_1,),)  {}


guards: check_tensor(L['b'], torch.float32, size=[10], stride=[1]) 
        check_tensor(L['x'], torch.float32, size=[10], stride=[1]) 

TRACED GRAPH
 opcode         name    target                   args          kwarg
  -------------  ------  -----------------------  ------------  --------
placeholder    l_x_    L_x_                     ()            {}
placeholder    l_b_    L_b_                     ()            {}
call_function  mul     &lt;built-in function mul&gt;  (l_x_, l_b_)  {}
output         output  output                   ((mul,),)     {}

check_tensor(L['b'], torch.float32, size=[10], stride=[1]) 
check_tensor(L['x'], torch.float32, size=[10], stride=[1])  # return x *b  # mp/ipykernel_1179164/26






the list of operations is a trace and is stored as a graph 

.::: {.columns}

::: {.column}</code></pre>
<p>import torch <span class="citation" data-cites="torch.compile">@torch.compile</span> def mse(x,y): z = (x -y) ** 2 return z.sum()</p>
<p>x = torch.randn(200) y = torch.randn(200)</p>
<p>mse(x,y)</p>
<pre><code>:::

::: {.column}</code></pre>
<p>def forward(l_x_: torch.Tensor, l_y_: torch.Tensor): sub = l_x_ - l_y_ z = sum **2 sum_1 = z.sum() return (sum_1,)</p>
<pre><code>:::

::: 

## linear traces 

Dynamo removes all control flow, if/else, loops, exceptions 

specializes (bakes in) all non-tensor objects (numbers, strings, classes )

::: {.columns}

::: {.column}</code></pre>
<p><span class="citation" data-cites="torch.compile">@torch.compile</span> def fn(f,n): y = x ** 2 if n &gt;= 0: return (n +1)* y else: return x /y</p>
<p>x = torch.randn(200) fn(x,2)</p>
<pre><code>:::

::: {.column}</code></pre>
<p>def forward(l_x_: torch.Tensor): y = l_x_ ** 2 mul 3*x return (mul,)</p>
<pre><code>:::

::: 

Trace integers symbolically 

by default it specilizes on every integer in the graph but if a subsequent vall the value changes it traces symbolically 
but 0 or 1 are always speciaized 



## multiple traces </code></pre>
<p>import torch from typing import List</p>
<p>import torch._dynamo torch._dynamo.config.suppress_errors = True</p>
<p>def my_compiler(gm: torch.fx.GraphModule, example_inputs: List[torch.Tensor]): print(“my compiler() called with fx graph”) gm.graph.print_tabular() return gm</p>
<p><span class="citation" data-cites="torch.compile">@torch.compile</span>(backend=my_compiler) def toy_example(a,b): x = a / (torch.abs(a)+1) if b.sum() &lt; 0: b = b * -1 return x *b</p>
<p>for _ in range(100): toy_example(torch.randn(10), torch.randn(10))</p>
<p>import torch from typing import List</p>
<p>import torch._dynamo torch._dynamo.config.suppress_errors = True</p>
<p>def my_compiler(gm: torch.fx.GraphModule, example_inputs: List[torch.Tensor]): print(“my compiler() called with fx graph”) gm.graph.print_tabular() return gm ```</p>
</section>
<section id="implementation-3" class="level2">
<h2 class="anchored" data-anchor-id="implementation-3">implementation</h2>
<p>pep 523, allows python function to see unevaluated frames, function + arguments</p>
<p>normally just calls the function</p>
<p>in torch</p>
<ol type="1">
<li>calls guards - maybe reform graph and compile</li>
<li>gets multiple graphs + functions</li>
<li>some functions may call the graph processor</li>
<li>all control flow stays in the functions</li>
</ol>


</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/normrubin\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../lectures/12_memory.html" class="pagination-link" aria-label="Dynamic Memory Management">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Dynamic Memory Management</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../lectures/14_gpu_compilers.html" class="pagination-link" aria-label="GPU Compilers">
        <span class="nav-page-text">GPU Compilers</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://normrubin.github.io/">EECS 7398 website</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions"><ul><li><a href="https://github.com/normrubin/normrubin.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This page is built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>