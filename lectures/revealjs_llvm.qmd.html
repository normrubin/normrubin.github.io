<!DOCTYPE html>
<html lang="en"><head>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/tabby.min.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.39">

  <title>EECE7398 Fall 2024 – using llvm</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../site_libs/revealjs/dist/theme/quarto-bbe7401fe57d4b791b917637bb662036.css">
  <link href="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
  <script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
  <link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<meta property="og:title" content="using llvm – EECE7398 Fall 2024">
<meta property="og:site_name" content="EECE7398 Fall 2024">
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">using llvm</h1>

<div class="quarto-title-authors">
</div>

</section>
<section id="remember-that-project-proposals-are-due-oct-22" class="slide level2 scrollable">
<h2>remember that project proposals are due oct 22!</h2>
<p>At the end of the course, you’ll do a language implementation research project. This is an open-ended and open-source project that can be on any topic that you can construe as being about compiler hacking. The final product is an experience report on the course blog where you rigorously evaluate the success of your implementation.</p>
<p>You can work individually or in groups of 2–3 people.</p>
<p>Proposal</p>
<p>answer these three questions</p>
<ol type="1">
<li>What will you do?</li>
<li>How will you do it?</li>
<li>How will you empirically measure success?</li>
</ol>
<p>I will have feedback on how to approach your project.</p>
<p>Implementation</p>
<p>The main phase, of course, is implementing the thing you said you would implement. I recommend you keep a “lab notebook” to log your thoughts, attempts, and frustrations—this will come in handy for the report you’ll write about the project.</p>
<p>Evaluation</p>
<p>A major part of your project is an empirical evaluation. To design your evaluation strategy, you will need to consider at least these things:</p>
<ol type="1">
<li>Where will you get the input code you’ll use in your evaluation?</li>
<li>How will you check the correctness of your implementation? If you’ve implemented an optimization, for example, “correctness” means that the transformed programs behave the same way as the original programs.</li>
<li>How will you measure the benefit (in performance, energy, complexity, etc.) of your implementation?</li>
<li>How will you present the data you collect from your empirical evaluation?</li>
</ol>
<p>Other questions may be relevant depending on the project you choose. Consider the SIGPLAN empirical evaluation guidelines when you design your methodology.</p>
<p>Experience Report</p>
<p>For the main project deadline, you will write up the project’s outcomes in the form of a post on the course blog. Your writeup should answer these questions:</p>
<ol type="1">
<li>What was the goal?</li>
<li>What did you do? (Include both the design and the implementation.)</li>
<li>What were the hardest parts to get right?</li>
<li>Were you successful? (Report rigorously on your empirical evaluation.)</li>
</ol>
<p>To submit your report, open a pull request in the course’s GitHub repository to add your post to the blog.</p>
</section>
<section id="using-llvm" class="slide level2">
<h2>Using LLVM</h2>
<p>handy links</p>
<p><a href="https://www.cs.cornell.edu/~asampson/blog/llvm.html">Adrians tutorial</a></p>
<p><a href="https://github.com/sampsyo/llvm-pass-skeleton">skeleton code</a></p>
<p><a href="https://llvm.org/docs/LangRef.html">llvm doc</a></p>
<p><a href="https://llvm.org/docs/ProgrammersManual.html">llvm programmers guide</a></p>
<p>google, github pilot and chatgpt are very useful.</p>
</section>
<section id="install-clang-and-cmake" class="slide level2">
<h2>install clang and cmake</h2>
<p>how to install clang and cmake</p>
<pre><code>sudo apt install clang cmake </code></pre>
</section>
<section>
<section id="lets-take-a-look-at-llvm-ir" class="title-slide slide level1 center scrollable">
<h1>lets take a look at llvm ir</h1>
<pre><code>// temp.c
int main(int argc, char** argv){
       return argc;}</code></pre>
<p>dump the ir (flags)</p>
<ol type="1">
<li>-emit-llvm prints the ir</li>
<li>-S print as text not as binary</li>
<li>0 - output to stdout</li>
</ol>
<p>clang -emit-llvm -S -o - temp.c</p>
</section>
<section id="llvm-ir" class="slide level2">
<h2>llvm ir</h2>
<pre><code>clang -emit-llvm -S -o - temp.c

; ModuleID = 'temp.c'
source_filename = "temp.c"
target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-pc-linux-gnu"

; Function Attrs: noinline nounwind optnone uwtable
define dso_local i32 @main(i32 noundef %0, i8** noundef %1) #0 {
  %3 = alloca i32, align 4
  %4 = alloca i32, align 4
  %5 = alloca i8**, align 8
  store i32 0, i32* %3, align 4
  store i32 %0, i32* %4, align 4
  store i8** %1, i8*** %5, align 8
  %6 = load i32, i32* %4, align 4
  ret i32 %6
}</code></pre>
<p>compared to bril</p>
<p>more complex types, variables are %n, assumes a stack, must be in ssa</p>
</section>
<section id="using-copilot" class="slide level2">
<h2>using copilot</h2>
<p><strong><em>what does the llvm alloca do</em></strong></p>
<p>In LLVM, the alloca instruction is used to allocate memory on the stack. It stands for “allocate” and is similar to the alloca function in C. The memory allocated by alloca is automatically freed when the function returns, making it suitable for allocating temporary storage within a function.</p>
</section>
<section id="alloca" class="slide level2">
<h2>alloca</h2>
<pre><code>Explanation of alloca Instruction
Syntax: alloca &lt;type&gt;, &lt;num_elements&gt;, &lt;alignment&gt;
&lt;type&gt;: The type of the elements to be allocated.
&lt;num_elements&gt;: The number of elements to allocate (optional, defaults to 1).
&lt;alignment&gt;: The alignment of the allocated memory (optional).</code></pre>
</section>
<section id="example" class="slide level2">
<h2>example</h2>
<pre><code>Explanation:
%3 = alloca i32, align 4:

Allocates memory for a single i32 (32-bit integer) on the stack.
The allocated memory is aligned to a 4-byte boundary.
The result is a pointer to the allocated memory, stored in the variable %3.</code></pre>
</section>
<section id="example-2" class="slide level2">
<h2>example 2</h2>
<pre><code>%4 = alloca i32, align 4:

Similar to the first instruction, this allocates memory for another i32 on the stack with 4-byte alignment.
The result is stored in the variable %4.


%5 = alloca i8**, align 8:

Allocates memory for a single i8** (pointer to a pointer to an 8-bit integer) on the stack.
The allocated memory is aligned to an 8-byte boundary.
The result is stored in the variable %5.</code></pre>
</section>
<section id="allocate-usage" class="slide level2">
<h2>allocate usage</h2>
<pre><code>Usage:
Temporary Storage: alloca is typically used for temporary storage within a function, such as local variables.
Automatic Deallocation: The memory allocated by alloca is automatically deallocated when the function returns, so there is no need to manually free it.
Example in Context:
In the provided LLVM IR code, the alloca instructions are used to allocate space for local variables %3, %4, and %5 on the stack. These variables are then used to store values and perform operations within the main function.</code></pre>
</section>
<section id="allocate" class="slide level2">
<h2>allocate</h2>
<pre><code>In this function:

%3 is allocated for an i32 and initialized to 0.
%4 is allocated for an i32 and initialized with the value of the first argument %0.
%5 is allocated for an i8** and initialized with the value of the second argument %1.
The value stored in %4 is loaded into %6 and returned.
This demonstrates how alloca is used to manage local variables within an LLVM function.</code></pre>
</section>
<section id="llvm-classes" class="slide level2">
<h2>llvm classes</h2>
<p><strong><em>what is an llvm value</em></strong></p>
<pre><code>In LLVM, a Value is a fundamental class that represents a typed constant or variable. It is the base class for all values computed by a program that may be used as operands to other values. This includes constants, instructions, function arguments, and more.</code></pre>
</section>
<section id="value-continued" class="slide level2">
<h2>value continued</h2>
<pre><code>Key Points about llvm::Value:
Base Class: llvm::Value is the base class for many other classes in LLVM, such as llvm::Instruction, llvm::Constant, llvm::Argument, and llvm::GlobalVariable.
Typed: Every Value has a type, represented by the llvm::Type class. This type information is crucial for type checking and code generation.
Use-Def Chain: Value objects maintain a list of uses, which are the places where the value is used. This is part of the use-def (use-definition) chain, which is important for optimizations and transformations.</code></pre>
</section>
<section id="value-continued-1" class="slide level2">
<h2>value continued</h2>
<pre><code>Common Subclasses of llvm::Value:
llvm::Instruction: Represents an individual instruction in the LLVM IR.
llvm::Constant: Represents a constant value, such as an integer or floating-point constant.
llvm::Argument: Represents an argument to a function.
llvm::GlobalVariable: Represents a global variable.</code></pre>
</section>
<section id="llvm-classes-llvm-is-c-but-does-not-use-standard-library" class="slide level2 scrollable">
<h2>llvm classes (llvm is c++ but does not use standard library)</h2>
<ol type="1">
<li>llvm does not use char* or std::string, it has something else called a StringRef.</li>
<li>there is no std::cout or std::cerr there are outs(), errs()</li>
<li>lot of built in data structures</li>
<li>complex class hierarchy</li>
</ol>
</section>
<section id="class-hierarchy" class="slide level2">
<h2>class hierarchy</h2>
<div class="cell" data-reveal="true" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb12-1"><a></a>%%{init: {"flowchart": {"htmlLabels": false}} }%%</span>
<span id="cb12-2"><a></a></span>
<span id="cb12-3"><a></a>flowchart TD;</span>
<span id="cb12-4"><a></a>Value --&gt; Argument ;</span>
<span id="cb12-5"><a></a>Value --&gt; other["..."];</span>
<span id="cb12-6"><a></a>Value --&gt; User;</span>
<span id="cb12-7"><a></a>User --&gt; Constant</span>
<span id="cb12-8"><a></a>User--&gt; Operator</span>
<span id="cb12-9"><a></a>User--&gt; Instruction</span>
<span id="cb12-10"><a></a>Constant --&gt; ConstantExpr</span>
<span id="cb12-11"><a></a>Constant--&gt; ConstantData</span>
<span id="cb12-12"><a></a>Operator--&gt; ConcreteOperator</span>
<span id="cb12-13"><a></a>Instruction--&gt; UnaryInst</span>
<span id="cb12-14"><a></a>ConstantData --&gt; ConstantInt</span>
<span id="cb12-15"><a></a>ConstantData --&gt; UndefValue</span>
<span id="cb12-16"><a></a>Instruction --&gt; BinaryOperator</span>
<span id="cb12-17"><a></a>Instruction--&gt; CallBase</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart": {"htmlLabels": false}} }%%

flowchart TD;
Value --&gt; Argument ;
Value --&gt; other["..."];
Value --&gt; User;
User --&gt; Constant
User--&gt; Operator
User--&gt; Instruction
Constant --&gt; ConstantExpr
Constant--&gt; ConstantData
Operator--&gt; ConcreteOperator
Instruction--&gt; UnaryInst
ConstantData --&gt; ConstantInt
ConstantData --&gt; UndefValue
Instruction --&gt; BinaryOperator
Instruction--&gt; CallBase
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>Instructions are a kind of Value, since everything is in SSA form, operands are pointers to instructions</p>
</section>
<section id="plugins" class="slide level2">
<h2>plugins</h2>
<p>An LLVM plugin is a shared library that can add additional functionality to the LLVM infrastructure. Plugins can be used to add new passes, analyses, targets, and more.</p>
<p>Plugins are dynamically loaded into LLVM. Once loaded, a plugin can register new command-line options, passes, etc., that are then available for use in that invocation of the tool.</p>
<p>The advantage for us is that using a plugin means you do not have to ever build llvm from source.</p>
</section>
<section id="pass-starter" class="slide level2">
<h2>pass starter</h2>
<p>There is a cs6120 package that makes setting up the build process for plugins simpler</p>
<p><a href="https://github.com/sampsyo/llvm-pass-skeleton">pass starter</a></p>
<p>This has branches</p>
<p>master - prints names of functions</p>
<p>containers - prints everything</p>
<p>mutate - changes the code</p>
<p>rtlib - easier way to insert code with needing irbuilder</p>
</section>
<section id="using-llvm-branches" class="slide level2">
<h2>using llvm branches</h2>
<p>To clone a specific branch from a GitHub repository, you can use the git clone command with the -b option followed by the branch name and the repository URL. Here is the syntax:</p>
<p>git clone -b <branch-name> <repository-url> <target-directory></target-directory></repository-url></branch-name></p>
<p>to switch branches</p>
<p>git fetch –all</p>
<p>git checkout <branch-name></branch-name></p>
</section>
<section id="using-the-master-branch" class="slide level2">
<h2>using the master branch</h2>
<p>git clone https://github.com/sampsyo/llvm-pass-skeleton</p>
<p>ls gives</p>
<p>CMakeLists.txt LICENSE README.md skeleton</p>
<p>ls skeleton CMakeLists.txt Skeleton.cpp</p>
</section>
<section id="skeleton.cpp" class="slide level2">
<h2>Skeleton.cpp</h2>
<pre><code>#include "llvm/Pass.h"
#include "llvm/Passes/PassBuilder.h"
#include "llvm/Passes/PassPlugin.h"
#include "llvm/Support/raw_ostream.h"

using namespace llvm;

namespace {

struct SkeletonPass : public PassInfoMixin&lt;SkeletonPass&gt; {
    PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;AM) {
        for (auto &amp;F : M) {
            errs() &lt;&lt; "I saw a function called " &lt;&lt; F.getName() &lt;&lt; "!\n";
        }
        return PreservedAnalyses::all();
    };
};

}

extern "C" LLVM_ATTRIBUTE_WEAK ::llvm::PassPluginLibraryInfo
llvmGetPassPluginInfo() {
    return {
        .APIVersion = LLVM_PLUGIN_API_VERSION,
        .PluginName = "Skeleton pass",
        .PluginVersion = "v0.1",
        .RegisterPassBuilderCallbacks = [](PassBuilder &amp;PB) {
            PB.registerPipelineStartEPCallback(
                [](ModulePassManager &amp;MPM, OptimizationLevel Level) {
                    MPM.addPass(SkeletonPass());
                });
        }
    };
}</code></pre>
</section>
<section id="how-to-build-this" class="slide level2">
<h2>how to build this</h2>
<pre><code>~/llvm/llvm-pass-skeleton$ mkdir build
cd build 
cmake ..</code></pre>
<p>This generates build/skeleton/SkeletonPass.so</p>
</section>
<section id="how-to-run-a-plugin" class="slide level2">
<h2>how to run a plugin</h2>
<p>to run this</p>
<pre><code>clang -fpass-plugin=llvm-pass-skeleton/build/skeleton/SkeletonPass.so a.cpp</code></pre>
<p>creates a.out and prints out info from the pass</p>
<p>to make this easier to use you might create a bash script or a makefile</p>
</section>
<section id="look-at-the-post-on-containers" class="slide level2">
<h2>look at the post on containers</h2>
</section>
<section id="getting-more-info" class="slide level2">
<h2>getting more info</h2>
<p>Some helpful llvm operations</p>
<pre><code>errs() &lt;&lt; "function Body:\n";
errs() &lt;&lt; F &lt;&lt; '\n"; '</code></pre>
<p>output</p>
<pre><code>I saw a function called main!
function Body:
; Function Attrs: noinline nounwind optnone uwtable
define dso_local i32 @main(i32 noundef %0, i8** noundef %1) #0 {
  %3 = alloca i32, align 4
  %4 = alloca i32, align 4
  %5 = alloca i8**, align 8
  store i32 0, i32* %3, align 4
  store i32 %0, i32* %4, align 4
  store i8** %1, i8*** %5, align 8
  %6 = load i32, i32* %4, align 4
  ret i32 %6
}</code></pre>
</section>
<section id="entering-containers" class="slide level2">
<h2>entering containers</h2>
<pre><code>PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;AM)
        {
            for (auto &amp;F : M)
            {
                errs() &lt;&lt; "I saw a function called " &lt;&lt; F.getName() &lt;&lt; "!\n";
                for (auto &amp;B : F)
                {
                    errs() &lt;&lt; "starting block\n";
                    errs() &lt;&lt; B &lt;&lt; "\n";
                    for (auto &amp;I : B)
                    {
                        errs() &lt;&lt; "instr:" &lt;&lt; I &lt;&lt; "\n";
                    }
                };
            };
            return PreservedAnalyses::all();
        };
</code></pre>
<pre><code>I saw a function called main!
starting block

  %3 = alloca i32, align 4
  %4 = alloca i32, align 4
  %5 = alloca i8**, align 8
  store i32 0, i32* %3, align 4
  store i32 %0, i32* %4, align 4
  store i8** %1, i8*** %5, align 8
  %6 = load i32, i32* %4, align 4
  ret i32 %6

instr:  %3 = alloca i32, align 4
instr:  %4 = alloca i32, align 4
instr:  %5 = alloca i8**, align 8
instr:  store i32 0, i32* %3, align 4
instr:  store i32 %0, i32* %4, align 4
instr:  store i8** %1, i8*** %5, align 8
instr:  %6 = load i32, i32* %4, align 4
instr:  ret i32 %6</code></pre>
</section>
<section id="modify-the-program" class="slide level2">
<h2>modify the program</h2>
<p>find the binary operators and change them to multiplies</p>
<pre><code>#// temp.c
int main(int argc, char **argv)
{
       return argc + 5;
}</code></pre>
</section>
<section id="find-all-the-binary-operators" class="slide level2">
<h2>find all the binary operators</h2>
<p><strong><em>how do i find all the binary operators in a llvm plugin</em></strong></p>
<pre><code>to find all the binary operators in an LLVM plugin, you can iterate over all instructions in each function and use the isa&lt;BinaryOperator&gt; function to check if an instruction is a binary operator. If it is, you can then cast it to a BinaryOperator using dyn_cast&lt;BinaryOperator&gt; and process it as needed.

Here is an example of how you can modify your LLVM plugin to find and print all binary operators:</code></pre>
</section>
<section id="plugin" class="slide level2">
<h2>plugin</h2>
<pre><code>PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;AM)
    {
        for (auto &amp;F : M)
        {
            errs() &lt;&lt; "I saw a function called " &lt;&lt; F.getName() &lt;&lt; "!\n";
            for (auto &amp;B : F)
            {
                for (auto &amp;I : B)
                {
                    if (isa&lt;BinaryOperator&gt;(&amp;I))
                    {
                        errs() &lt;&lt; "instr:" &lt;&lt; I &lt;&lt; "\n";
                    }
                    auto *op = dyn_cast&lt;BinaryOperator&gt;(&amp;I);
                    errs() &lt;&lt; "from_op:" &lt;&lt; op &lt;&lt; "\n";
                }
            };
        };
        return PreservedAnalyses::all();
    }
</code></pre>
<p>output</p>
<pre><code>I saw a function called main!
I saw a function called main!
from_op:0x0
from_op:0x0
from_op:0x0
from_op:0x0
from_op:0x0
from_op:0x0
from_op:0x0
instr:  %7 = add nsw i32 %6, 5
from_op:0xb58610
from_op:0x0</code></pre>
</section>
<section id="getting-analysis-info" class="slide level2">
<h2>getting analysis info</h2>
<pre><code>   PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;MAM) {
        // Get the FunctionAnalysisManager.
        FunctionAnalysisManager &amp;FAM = MAM.getResult&lt;FunctionAnalysisManagerModuleProxy&gt;(M).getManager();

        for (Function &amp;F : M) {
            // Skip external functions.
            if (F.isDeclaration()) continue;

            // Get the DominatorTree for the function.
            DominatorTree &amp;DT = FAM.getResult&lt;DominatorTreeAnalysis&gt;(F);

            // Print the dominator tree.
            errs() &lt;&lt; "Dominator Tree for function: " &lt;&lt; F.getName() &lt;&lt; "\n";
            DT.print(errs());
        }</code></pre>
</section>
<section id="irbuilder" class="slide level2">
<h2>irbuilder</h2>
<pre><code>errs() &lt;&lt; "I saw a function called " &lt;&lt; F.getName() &lt;&lt; "!\n";
for (auto &amp;B : F){
    errs() &lt;&lt; B &lt;&lt; "\n";
    for (auto &amp;I : B){
        if (auto *op = dyn_cast&lt;BinaryOperator&gt;(&amp;I)){
            errs() &lt;&lt; "old inst " &lt;&lt; *op &lt;&lt; "\n";
            IRBuilder&lt;&gt; builder(op);
            Value *left = op-&gt;getOperand(0);  // first operand
            Value *right = op-&gt;getOperand(1); // second operad
            Value *mul = builder.CreateMul(left, right);

            errs() &lt;&lt; "new inst:" &lt;&lt; *mul &lt;&lt; "\n";

            errs() &lt;&lt; B &lt;&lt; "\n";

            // replace uses of op with mul
            for (auto &amp;U : op-&gt;uses()){
                int num = U.getOperandNo(); // which argument
                User *user = U.getUser();   // the instruction with the use
                errs() &lt;&lt; " user:" &lt;&lt; *user &lt;&lt; "   ";
                user-&gt;setOperand(num, mul);
                errs() &lt;&lt; *user &lt;&lt; "\n";
                }
            }
        }
    }
};
return PreservedAnalyses::none();</code></pre>
</section>
<section id="output" class="slide level2">
<h2>output</h2>
<pre><code>I saw a function called main!

  %3 = alloca i32, align 4
  %4 = alloca i32, align 4
  %5 = alloca i8**, align 8
  store i32 0, i32* %3, align 4
  store i32 %0, i32* %4, align 4
  store i8** %1, i8*** %5, align 8
  %6 = load i32, i32* %4, align 4
  %7 = add nsw i32 %6, 5
  ret i32 %7</code></pre>
</section>
<section id="output-2" class="slide level2">
<h2>output 2</h2>
<pre><code>
old inst   %7 = add nsw i32 %6, 5
new inst:  %7 = mul i32 %6, 5

  %3 = alloca i32, align 4
  %4 = alloca i32, align 4
  %5 = alloca i8**, align 8
  store i32 0, i32* %3, align 4
  store i32 %0, i32* %4, align 4
  store i8** %1, i8*** %5, align 8
  %6 = load i32, i32* %4, align 4
  %7 = mul i32 %6, 5
  %8 = add nsw i32 %6, 5
  ret i32 %8

 user:  ret i32 %8     ret i32 %7
</code></pre>
</section>
<section id="more-complex-transforms---for-instrumentation" class="slide level2">
<h2>more complex transforms - for instrumentation</h2>
<p>instrumentation code in c not using builder</p>
<p>insert calls to functions and link them in</p>
<p>using IRBuilder is a mess, So I’m going to show a trick that makes it much simpler</p>
</section>
<section id="chat-gpt" class="slide level2 scrollable">
<h2>chat gpt</h2>
<p><strong><em>how do i write an instrumentation function in c for llvm, use a plugin pass to insert a call to the instrumentation routine</em></strong></p>
<ol type="1">
<li>Write the Instrumentation Function in C: Create a C function that you want to call from your LLVM pass.</li>
<li>Create an LLVM Pass: Write an LLVM pass that inserts a call to the instrumentation function.</li>
<li>Build and Load the Pass: Compile the pass and load it using the opt tool or integrate it into your build system.</li>
</ol>
</section>
<section id="instrumentation-routine" class="slide level2">
<h2>instrumentation routine</h2>
<pre><code>void instrument_function(const char* bb_name) {
    printf("Instrumentation function called for basic block: %s\n", bb_name);
}</code></pre>
</section>
<section id="pass" class="slide level2">
<h2>pass</h2>
<pre><code>   PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;MAM) {
        LLVMContext &amp;Ctx = M.getContext();
        IRBuilder&lt;&gt; Builder(Ctx);

        // Declare the instrumentation function as an external function
        FunctionType *FuncType = FunctionType::get(Type::getVoidTy(Ctx), Type::getInt8PtrTy(Cctx), false);
        FunctionCallee InstrumentFunc =
                  M.getOrInsertFunction("instrument_function", FuncType);

        for (Function &amp;F : M) {

            // Insert the call at the beginning of each basic block
            for (BasicBlock &amp;BB : F) {
                Builder.SetInsertPoint(&amp;BB, BB.begin());

                // Create a global string for the basic block name
                Value *BBName = Builder.CreateGlobalStringPtr(BB.getName());

                // Create the call to the instrumentation function
                Builder.CreateCall(InstrumentFunc, BBName);
            }
        }

        return PreservedAnalyses::none();


</code></pre>
</section>
<section id="starter-code" class="slide level2">
<h2>starter code</h2>
<pre><code>rm -r llvm-pass-skeleton
git clone  -b rtlib  https://github.com/sampsyo/llvm-pass-skeleton.git
cd llvm-pass-skeleton
mkdir -p build 
cd build 
cmake ..
make</code></pre>
</section>
<section id="adrians-skeleton" class="slide level2">
<h2>Adrians skeleton</h2>
<pre><code>struct SkeletonPass : public PassInfoMixin&lt;SkeletonPass&gt; {
    PreservedAnalyses run(Module &amp;M, ModuleAnalysisManager &amp;AM) {
        for (auto &amp;F : M.functions()) {

            // Get the function to call from our runtime library.
            LLVMContext &amp;Ctx = F.getContext();
            std::vector&lt;Type*&gt; paramTypes = {Type::getInt32Ty(Ctx)};
            Type *retType = Type::getVoidTy(Ctx);
            FunctionType *logFuncType = FunctionType::get(retType, paramTypes, false);
            FunctionCallee logFunc =
                F.getParent()-&gt;getOrInsertFunction("logop", logFuncType);

            for (auto &amp;B : F) {
                for (auto &amp;I : B) {
                    if (auto *op = dyn_cast&lt;BinaryOperator&gt;(&amp;I)) {
                        // Insert *after* `op`.
                        IRBuilder&lt;&gt; builder(op);
                        builder.SetInsertPoint(&amp;B, ++builder.GetInsertPoint());

                        // Insert a call to our function.
                        Value* args[] = {op};
                        builder.CreateCall(logFunc, args);

                        return PreservedAnalyses::none();
                    }
                }
            }

        }
        return PreservedAnalyses::all();
    }
};</code></pre>
</section>
<section id="adrians-instrumentation-code" class="slide level2">
<h2>Adrians instrumentation code</h2>
<pre><code>#include &lt;stdio.h&gt;
void logop(int i) {
    printf("computed: %i\n", i);
}</code></pre>
</section>
<section id="link-together" class="slide level2">
<h2>link together</h2>
<pre><code>cd llvm-pass-skeleton
cc -c rtlib.c --- generates rtlib.o 
clang  -fpass-plugin=build/skeleton/SkeletonPass.so -c test.cpp   -- generates test.o
cc test.o rtlib.o  -- links it together 
./a.out     --   runs it </code></pre>
</section>
<section id="homework" class="slide level2">
<h2>Homework</h2>
<p>Follow the LLVM tutorial blog post far enough to implement a pass that changes program execution.</p>
<p>This is intentionally open-ended. You can be as ambitious or as unambitious as you want. An example of an unambitious but acceptable task would be to print out a message every time the program uses floating-point division.</p>
<p>An example of an ambitious task would be to implement an optimization on LLVM IR and make sure it speeds things up in actual wall-clock time execution.</p>
<p>Find a real-ish C/C++ program somewhere and run your pass on it to observe the results.</p>


</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp("https:\/\/normrubin\.github\.io\/");
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>